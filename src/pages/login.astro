---
import Layout from "../layouts/Layout.astro";
---
<Layout>
  <main class="min-h-screen bg-gradient-to-br from-bj-green to-bj-black text-bj-white flex items-center justify-center p-6">
    <section class="w-full max-w-md bg-black/60 backdrop-blur rounded-xl border border-white/10 p-6 shadow-xl animate-fade-in">
      <h1 class="text-2xl font-semibold mb-4">Iniciar sesión</h1>
      <p class="text-bj-gray mb-6">Accede a tu cuenta para continuar.</p>

      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm mb-1" for="identity">Usuario o Email</label>
          <input 
            id="identity" 
            name="identity" 
            type="text" 
            class="w-full rounded-md bg-white/10 border border-white/20 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-bj-green" 
            required 
            placeholder="usuario123 o tu@email.com"
          />
        </div>

        <div>
          <label class="block text-sm mb-1" for="password">Contraseña</label>
          <input 
            id="password" 
            name="password" 
            type="password" 
            class="w-full rounded-md bg-white/10 border border-white/20 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-bj-green" 
            required
            placeholder="••••••••"
          />
        </div>

        <label class="flex items-center gap-2 text-sm">
          <input id="remember" name="remember" type="checkbox" />
          <span>Recordar sesión</span>
        </label>

        <div id="message" class="text-sm text-red-500 hidden"></div>

        <button 
          type="submit" 
          class="w-full bg-bj-green hover:bg-green-600 transition-colors text-black font-semibold rounded-md px-3 py-2 flex items-center justify-center"
        >
          <span>Iniciar sesión</span>
          <div role="status" class="ml-2 hidden">
            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </button>
      </form>
      <div class="mt-4 text-sm flex items-center justify-between">
        <a id="forgotLink" href="#" class="underline hover:text-white text-bj-gray">¿Olvidaste tu contraseña?</a>
        <a href="/register" class="underline hover:text-white text-bj-gray">Crear cuenta</a>
      </div>

      <div class="mt-2">
        <button id="resendConfirm" class="hidden w-full text-sm bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2">Reenviar email de confirmación</button>
        <div id="resendMsg" class="text-xs mt-2 hidden"></div>
      </div>

      <div id="forgotSection" class="mt-4 hidden">
        <div class="bg-black/40 border border-white/10 rounded-md p-3">
          <p class="text-sm text-bj-gray mb-2">Ingresa tu email (o usuario) y te enviaremos un enlace para crear una nueva contraseña.</p>
          <form id="forgotForm" class="space-y-3">
            <input id="forgotIdentity" type="text" class="w-full rounded-md bg-white/10 border border-white/20 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-bj-green" placeholder="tu@email.com o usuario" required />
            <button type="submit" class="w-full bg-bj-green hover:bg-green-600 transition-colors text-black font-semibold rounded-md px-3 py-2">Enviar enlace de recuperación</button>
            <div id="forgotMsg" class="text-sm hidden"></div>
          </form>
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  import { signIn } from "../lib/auth";
  import { getSupabase } from "../lib/supabaseClient";

  const form = document.getElementById('loginForm') as HTMLFormElement;
  const message = document.getElementById('message') as HTMLDivElement;
  const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const spinner = submitButton?.querySelector('[role="status"]') as HTMLDivElement;

  const forgotLink = document.getElementById('forgotLink') as HTMLAnchorElement | null;
  const forgotSection = document.getElementById('forgotSection') as HTMLDivElement | null;
  const forgotForm = document.getElementById('forgotForm') as HTMLFormElement | null;
  const forgotMsg = document.getElementById('forgotMsg') as HTMLDivElement | null;

  const site = (import.meta as any).env?.PUBLIC_SITE_URL || (typeof window !== 'undefined' ? window.location.origin : '');
  const redirectTo = String(site || '').replace(/\/$/, '') + '/recover';
  const confirmRedirect = String(site || '').replace(/\/$/, '') + '/login';

  function showLoading(loading: boolean) {
    if (loading) {
      submitButton.disabled = true;
      spinner.classList.remove('hidden');
      submitButton.querySelector('span')!.textContent = 'Iniciando sesión...';
    } else {
      submitButton.disabled = false;
      spinner.classList.add('hidden');
      submitButton.querySelector('span')!.textContent = 'Iniciar sesión';
    }
  }

  function showError(text: string) {
    message.textContent = text;
    message.classList.remove('hidden');
    // Mostrar botón de reenviar si es el típico error de email sin confirmar
    const normalized = (text || '').toLowerCase();
    const showResend = normalized.includes('confirma tu email') || normalized.includes('email not confirmed');
    const btn = document.getElementById('resendConfirm') as HTMLButtonElement | null;
    if (btn) {
      if (showResend) btn.classList.remove('hidden'); else btn.classList.add('hidden');
    }
  }

  function hideError() {
    message.textContent = '';
    message.classList.add('hidden');
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();
    showLoading(true);

    try {
      const fd = new FormData(form);
      const identity = String(fd.get('identity') || '').trim();
      const password = String(fd.get('password') || '');

      if (!identity || !password) {
        throw new Error('Por favor ingresa tu usuario/email y contraseña');
      }

      // Determinar si es email o username
      let email = identity;
      if (!identity.includes('@')) {
        const supabase = getSupabase();
        const { data: profile } = await supabase
          .from('profiles')
          .select('email')
          .eq('username', identity)
          .maybeSingle();

        if (!profile?.email) {
          throw new Error('Usuario no encontrado');
        }
        email = profile.email;
      }

      const { data, error } = await signIn(email, password);
      if (error) throw error;

      // Login exitoso
      message.textContent = 'Sesión iniciada correctamente. Redirigiendo...';
      message.classList.remove('hidden', 'text-red-500');
      message.classList.add('text-green-500');

      // Revisar rol y redirigir en consecuencia
      const supabase2 = getSupabase();
      const { data: { session } } = await supabase2.auth.getSession();
      let target = '/dashboard';
      if (session?.user?.id) {
        const { data: prof } = await supabase2
          .from('profiles')
          .select('role')
          .eq('id', session.user.id)
          .single();
        if (prof?.role === 'admin') target = '/admin';
      }
      setTimeout(() => { window.location.href = target; }, 800);

    } catch (err: any) {
      showError(err?.message || 'No se pudo iniciar sesión');
    } finally {
      showLoading(false);
    }
  });

  // Toggle sección de recuperación
  forgotLink?.addEventListener('click', (e) => {
    e.preventDefault();
    if (!forgotSection) return;
    const isHidden = forgotSection.classList.contains('hidden');
    if (isHidden) {
      forgotSection.classList.remove('hidden');
    } else {
      forgotSection.classList.add('hidden');
    }
  });

  // Enviar email de recuperación
  forgotForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!forgotMsg) return;
    forgotMsg.classList.add('hidden');
    forgotMsg.classList.remove('text-red-500', 'text-green-500');
    try {
      const supabase = getSupabase();
      const identityInput = document.getElementById('forgotIdentity') as HTMLInputElement | null;
      const identity = identityInput ? identityInput.value.trim() : '';
      if (!identity) throw new Error('Ingresa tu email o usuario');

      let email = identity;
      if (!identity.includes('@')) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('email')
          .eq('username', identity)
          .maybeSingle();
        if (!profile?.email) throw new Error('Usuario no encontrado');
        email = profile.email;
      }

      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
      if (error) throw error;
      forgotMsg.textContent = 'Te enviamos un email con instrucciones para crear una nueva contraseña.';
      forgotMsg.classList.remove('hidden');
      forgotMsg.classList.add('text-green-500');
    } catch (err: any) {
      forgotMsg.textContent = err?.message || 'No se pudo enviar el email de recuperación';
      forgotMsg.classList.remove('hidden');
      forgotMsg.classList.add('text-red-500');
    }
  });

  // Reenviar email de confirmación (signup)
  document.getElementById('resendConfirm')?.addEventListener('click', async () => {
    const msg = document.getElementById('resendMsg') as HTMLDivElement | null;
    if (msg) { msg.classList.add('hidden'); msg.classList.remove('text-red-500','text-green-500'); }
    try {
      const supabase = getSupabase();
      const identityInput = document.getElementById('identity') as HTMLInputElement | null;
      const identity = identityInput ? identityInput.value.trim() : '';
      if (!identity) throw new Error('Ingresa tu email o usuario en el formulario');
      let email = identity;
      if (!identity.includes('@')) {
        const { data: profile } = await supabase
          .from('profiles')
          .select('email')
          .eq('username', identity)
          .maybeSingle();
        if (!profile?.email) throw new Error('Usuario no encontrado');
        email = profile.email;
      }
      const { error } = await supabase.auth.resend({ type: 'signup', email, options: { emailRedirectTo: confirmRedirect } });
      if (error) throw error;
      if (msg) { msg.textContent = 'Te reenviamos el email de confirmación. Revisa tu bandeja y spam.'; msg.classList.remove('hidden'); msg.classList.add('text-green-500'); }
    } catch (err: any) {
      if (msg) { msg.textContent = err?.message || 'No se pudo reenviar el email'; msg.classList.remove('hidden'); msg.classList.add('text-red-500'); }
    }
  });
</script>