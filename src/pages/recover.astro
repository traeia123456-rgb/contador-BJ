---
import Layout from "../layouts/Layout.astro";
---
<Layout title="Recuperar contraseña">
  <main class="max-w-md mx-auto p-6">
    <h1 class="text-2xl font-semibold mb-4">Recuperar contraseña</h1>
    <p id="status" class="mb-4 text-sm text-gray-600">Validando enlace...</p>

    <form id="recover-form" class="space-y-3 hidden">
      <div>
        <label class="block text-sm mb-1">Nueva contraseña</label>
        <input id="password" type="password" class="w-full px-3 py-2 border rounded" placeholder="••••••••" required />
      </div>
      <div>
        <label class="block text-sm mb-1">Confirmar contraseña</label>
        <input id="confirm" type="password" class="w-full px-3 py-2 border rounded" placeholder="••••••••" required />
      </div>
      <button type="submit" class="bg-black text-white px-4 py-2 rounded">Actualizar contraseña</button>
    </form>

    <div id="success" class="hidden mt-4 text-green-600">Contraseña actualizada correctamente. Redirigiendo al login...</div>
    <div id="error" class="hidden mt-4 text-red-600"></div>
  </main>

  <script>
    import { getSupabase } from "../lib/supabaseClient";
    const supabase = getSupabase();

    const statusEl = document.getElementById('status');
    const formEl = document.getElementById('recover-form');
    const errorEl = document.getElementById('error');
    const successEl = document.getElementById('success');

    (async () => {
      try {
        // Con detectSessionInUrl=true, Supabase procesa el hash y crea sesión
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;
        if (!session) {
          statusEl && (statusEl.textContent = 'Enlace inválido o caducado. Solicita un nuevo email.');
          return;
        }
        statusEl && (statusEl.textContent = 'Enlace verificado. Ingresa tu nueva contraseña.');
        formEl?.classList.remove('hidden');
      } catch (e) {
        statusEl && (statusEl.textContent = 'No fue posible validar el enlace.');
        errorEl && (errorEl.textContent = (e as Error)?.message ?? 'Error desconocido');
        errorEl && errorEl.classList.remove('hidden');
      }
    })();

    formEl?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      errorEl && errorEl.classList.add('hidden');
      const pass = (document.getElementById('password') as HTMLInputElement).value;
      const confirm = (document.getElementById('confirm') as HTMLInputElement).value;
      if (!pass || pass.length < 8) {
        errorEl && (errorEl.textContent = 'La contraseña debe tener al menos 8 caracteres');
        errorEl && errorEl.classList.remove('hidden');
        return;
      }
      if (pass !== confirm) {
        errorEl && (errorEl.textContent = 'Las contraseñas no coinciden');
        errorEl && errorEl.classList.remove('hidden');  
        return;
      }
      try {
        const { error } = await supabase.auth.updateUser({ password: pass });
        if (error) throw error;
        successEl && successEl.classList.remove('hidden');
        setTimeout(() => { window.location.href = '/login'; }, 1500);
      } catch (e) {
        errorEl && (errorEl.textContent = (e as Error)?.message ?? 'No se pudo actualizar la contraseña');
        errorEl && errorEl.classList.remove('hidden');  
      }
    });
  </script>
</Layout>