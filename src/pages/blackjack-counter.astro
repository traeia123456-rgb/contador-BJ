---
import Layout from "../layouts/Layout.astro";
---
<Layout>
  <main class="min-h-screen bg-gradient-to-br from-bj-green to-bj-black text-bj-white p-6">
    <header class="flex items-center justify-between max-w-6xl mx-auto">
      <h1 class="text-2xl font-semibold">Dashboard</h1>
      <div class="flex items-center gap-2">
        <a href="/blackjack-counter" target="_blank" class="bg-green-600 hover:bg-green-700 border border-green-500 rounded-md px-3 py-2 font-semibold"> Contador Blackjack</a>
        <button id="open-create-project" class="hidden bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2">Crear proyecto</button>
        <a id="admin-link" href="/admin" class="hidden bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2">Admin</a>
        <button id="logout" class="bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2">Salir</button>
      </div>
    </header>
    <!-- M贸dulo de creaci贸n de proyecto (solo usuarios) -->
    <section id="user-create-project" class="hidden max-w-6xl mx-auto mt-4">
      <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6">
        <div class="flex items-start justify-between mb-4">
          <h2 class="text-xl">Crear proyecto</h2>
          <button id="close-user-create-project" class="px-2 py-1 bg-white/10 hover:bg-white/20 border border-white/20 rounded-md">Cerrar</button>
        </div>
        <form id="user-create-project-form" class="flex flex-col md:flex-row gap-2 mb-3">
          <input id="user-proj-name" placeholder="Nombre del proyecto" class="px-3 py-2 rounded-md bg-white/10 border border-white/20 md:w-64" />
          <select id="user-proj-ws" class="px-3 py-2 rounded-md bg-white/10 border border-white/20 md:w-64"></select>
          <button id="user-proj-submit" class="bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2" type="submit">Crear</button>
        </form>
        <p id="user-create-project-note" class="text-sm text-bj-white/70"></p>
      </div>
    </section>
    <!-- Indicador de edici贸n de snapshot -->
    <div id="editing-indicator" class="max-w-6xl mx-auto mt-3 hidden">
      <div class="flex items-center gap-3 bg-yellow-500/10 border border-yellow-400/30 text-yellow-300 rounded-md px-3 py-2">
        <span class="text-sm font-medium">Editando snapshot:</span>
        <span id="editing-indicator-name" class="text-sm"></span>
        <span id="editing-indicator-date" class="text-xs opacity-70 ml-auto"></span>
        <button id="editing-indicator-cancel" class="text-xs bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-2 py-1">Salir de edici贸n</button>
      </div>
    </div>

    <!-- Interfaz est谩tica solicitada: Racha y Manos / Porcentaje % / Diler -->
    <section class="mt-8 max-w-6xl mx-auto grid gap-6">
      <!-- Fila superior: 3 columnas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Racha y Manos -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-3 text-center">RACHA Y MANOS</h2>
          <div class="mb-4">
            <label class="text-sm text-bj-white/80">CANTIDAD DE MANOS</label>
            <input id="cantidad-manos" type="number" value="0" readonly class="mt-1 w-full px-3 py-2 rounded-md bg-white/10 border border-white/20" />
          </div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-bj-white/70">
                <th>ULTIMAS RACHAS</th>
                <th class="text-right">CANTIDAD</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>GANADAS</td><td id="r-ganadas" class="text-right">0</td></tr>
              <tr><td>PERDIDAS</td><td id="r-perdidas" class="text-right">0</td></tr>
              <tr><td>MANOS SIN BJ</td><td id="r-sin-bj" class="text-right">0</td></tr>
              <tr><td>GANE DOBLADA</td><td id="r-gane-doblada" class="text-right">0</td></tr>
              <tr><td>PERDI DOBLADA</td><td id="r-perdi-doblada" class="text-right">0</td></tr>
              <tr><td>DIVIDI GANE</td><td id="r-dividi-gane" class="text-right">0</td></tr>
              <tr><td>DIVIDI PERDI</td><td id="r-dividi-perdi" class="text-right">0</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Porcentaje % -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-3 text-center">PORCENTAJE %</h2>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-bj-white/70">
                <th>ACCION</th>
                <th>UNIDAD</th>
                <th class="text-right">%</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>GANADAS</td><td id="pct-ganadas-unit">0</td><td id="pct-ganadas" class="text-right">0%</td></tr>
              <tr><td>PERDIDAS</td><td id="pct-perdidas-unit">0</td><td id="pct-perdidas" class="text-right">0%</td></tr>
              <tr><td>EMPATE</td><td id="pct-empate-unit">0</td><td id="pct-empate" class="text-right">0%</td></tr>
              <tr class="text-bj-white/70"><td></td><td></td><td id="pct-total" class="text-right">100%</td></tr>
            </tbody>
          </table>
          <div class="mt-4 space-y-2">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-sm text-bj-white/70">Workspace</label>
                <select id="ws-select" class="w-full px-2 py-1 rounded-md bg-white/10 border border-white/20 text-sm"></select>
              </div>
              <div>
                <label class="text-sm text-bj-white/70">Proyecto</label>
                <select id="project-select" class="w-full px-2 py-1 rounded-md bg-white/10 border border-white/20 text-sm"></select>
              </div>
            </div>
            <div class="flex justify-center mt-2 gap-2">
              <button id="btn-save" class="px-4 py-2 rounded-md border border-white/20 bg-white/10 hover:bg-white/20">GUARDAR</button>
            </div>
            <!-- CTA persistente para solicitar acceso a workspace cuando no hay membres铆as -->
            <div id="workspace-cta" class="hidden mt-3">
              <div class="flex items-start gap-3 bg-yellow-500/10 border border-yellow-400/30 text-yellow-300 rounded-md px-3 py-2">
                <div class="text-sm">
                  <p class="m-0">No tienes acceso a ning煤n workspace. Pide a un administrador que te asigne uno.</p>
                  <p id="workspace-cta-msg" class="m-0 text-yellow-200/80 text-xs"></p>
                </div>
                <a id="workspace-cta-link" target="_blank" class="ml-auto text-xs bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-2 py-1">Solicitar acceso</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Diler -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-4">
          <h2 class="text-lg font-semibold mb-3 text-center">DILER</h2>
          <div class="mb-4">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-bj-white/70">
                  <th>RACHAS DILER</th>
                  <th class="text-right">CANTIDAD</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>VOLO</td><td id="d-streak-volo" class="text-right">0</td></tr>
                <tr><td>NO VOLO</td><td id="d-streak-novolo" class="text-right">0</td></tr>
                <tr><td>BJ</td><td id="d-streak-bj" class="text-right">0</td></tr>
              </tbody>
            </table>
          </div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-bj-white/70">
                <th>ACCION</th>
                <th>UNIDAD</th>
                <th class="text-right">%</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>VOLO</td><td id="d-pct-volo-unit">0</td><td id="d-pct-volo" class="text-right">0%</td></tr>
              <tr><td>NO VOLO</td><td id="d-pct-novolo-unit">0</td><td id="d-pct-novolo" class="text-right">0%</td></tr>
              <tr><td>BJ</td><td id="d-pct-bj-unit">0</td><td id="d-pct-bj" class="text-right">0%</td></tr>
              <tr class="text-bj-white/70"><td></td><td></td><td id="d-pct-total" class="text-right">100%</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla de manos -->
      <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-3">Registro de manos</h2>
        <!-- Controles de limpieza -->
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <label class="flex items-center gap-2 text-sm bg-white/5 px-2 py-1 rounded">
            <input id="chk-col-resultado" type="checkbox" checked /> Resultado
          </label>
          <label class="flex items-center gap-2 text-sm bg-white/5 px-2 py-1 rounded">
            <input id="chk-col-diler" type="checkbox" checked /> Diler
          </label>
          <button id="btn-clear-selected" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Limpiar seleccionadas</button>
          <button id="btn-clear-all" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Limpiar todo</button>
          <span class="mx-2 text-bj-white/40">路</span>
          <button id="btn-undo" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Deshacer</button>
          <button id="btn-clear-empty" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Limpiar filas vac铆as</button>
        </div>
        <table class="w-full text-sm" id="hands-table">
          <thead>
            <tr class="text-left text-bj-white/70">
              <th class="w-20">MANOS</th>
              <th>RESULTADO JUGADOR</th>
              <th class="w-40">DILER</th>
              <th class="w-16 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="hands-body"></tbody>
        </table>
        <!-- Pager -->
        <div class="flex items-center justify-between mt-3">
          <div class="text-sm text-bj-white/70">P谩gina <span id="page-number">1</span> de <span id="page-count">1</span></div>
          <div class="flex items-center gap-2">
            <button id="page-prev" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Anterior</button>
            <select id="page-select" class="px-2 py-1 rounded-md bg-white/10 border border-white/20 text-sm"></select>
            <button id="page-next" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Siguiente</button>
          </div>
        </div>

        <!-- listas de autocompletado -->
        <datalist id="resultado-options">
          <option value="GANE"></option>
          <option value="PERDI"></option>
          <option value="EMPATE"></option>
          <option value="BJ"></option>
          <option value="GANE DOBLADA"></option>
          <option value="PERDI DOBLADA"></option>
          <option value="DIVIDI GANE"></option>
          <option value="DIVIDI PERDI"></option>
        </datalist>
        <datalist id="diler-options">
          <option value="VOLO"></option>
          <option value="NO VOLO"></option>
          <option value="BJ"></option>
        </datalist>
      </div>

      <!-- Listado de snapshots (movido arriba) -->
      <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-4 mt-6">
        <div class="flex items-end gap-3">
          <div>
            <label class="text-sm text-bj-white/70">Desde</label>
            <input id="filter-from" type="date" class="px-2 py-1 rounded-md bg-white/10 border border-white/20 text-sm" />
          </div>
          <div>
            <label class="text-sm text-bj-white/70">Hasta</label>
            <input id="filter-to" type="date" class="px-2 py-1 rounded-md bg-white/10 border border-white/20 text-sm" />
          </div>
          <button id="btn-load-snapshots" class="px-3 py-1 rounded-md border border-white/20 bg-white/10 hover:bg-white/20 text-sm">Cargar snapshots</button>
        </div>
        <table class="w-full mt-4">
          <thead>
            <tr class="text-bj-white/70 text-left">
              <th class="py-1 pr-2">Fecha</th>
              <th class="py-1 pr-2">Nombre</th>
              <th class="py-1 pr-2">Workspace</th>
              <th class="py-1 pr-2">Proyecto</th>
              <th class="py-1 pr-2">Manos</th>
              <th class="py-1 pr-2 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="snapshots-body"></tbody>
        </table>
      </div>
    </section>
  </main>
</Layout>

<script>
  // Solo UI por ahora: acciones b谩sicas (logout) y mostrar enlace Admin si luego se habilita
  import { getSupabase } from "../lib/supabaseClient";
  const supabase = getSupabase(true);
  // Workspace/Proyecto caches
  let workspaces: Array<{id:string,name:string}> = [];
  let projectsByWs: Record<string, Array<{id:string,name:string}>> = {};
  // Estado de edici贸n de snapshot restaurado
  let editingSnapshotId: string | null = null;
  let editingSnapshotCreatedAt: string | null = null;
  let editingSnapshotWsId: string | null = null;
  let editingSnapshotProjectId: string | null = null;

  function setEditingIndicator(active: boolean, name?: string, dateISO?: string){
    const cont = document.getElementById('editing-indicator');
    const nameEl = document.getElementById('editing-indicator-name');
    const dateEl = document.getElementById('editing-indicator-date');
    if (!cont || !nameEl || !dateEl) return;
    if (active){
      cont.classList.remove('hidden');
      nameEl.textContent = name || '';
      dateEl.textContent = dateISO ? new Date(dateISO).toLocaleString() : '';
    } else {
      cont.classList.add('hidden');
      nameEl.textContent = '';
      dateEl.textContent = '';
    }
    const cancelBtn = document.getElementById('editing-indicator-cancel');
    cancelBtn?.addEventListener('click', () => {
      editingSnapshotId = null; editingSnapshotCreatedAt = null; editingSnapshotWsId = null; editingSnapshotProjectId = null;
      setEditingIndicator(false);
    });
  }

  // Check authentication status on page load
  (async () => {
    console.log('Checking authentication status...');
    let session: any = null; let error: any = null;
    try {
      const res = await supabase.auth.getSession();
      session = res?.data?.session || null;
      error = res?.error || null;
    } catch (e:any){
      error = e;
    }
    console.log('Session check result:', { session: session ? 'Active' : 'None', error });
    
    if (!session) {
      // Si el error proviene de refresh token inv谩lido, limpiar y redirigir
      const msg = error?.message || '';
      if (msg.includes('Invalid Refresh Token')){
        try { await supabase.auth.signOut(); } catch {}
        try { Object.keys(localStorage).forEach(k => { if (k.startsWith('sb-') && k.endsWith('-auth-token')) localStorage.removeItem(k); }); } catch {}
        window.location.href = '/login';
        return;
      }
      console.warn('No active session detected - user should log in');
      // Redirect to login page for security
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
      return;
    }
    
    console.log('User authenticated:', session.user.email);
    // Check if user is admin
    const { data: isAdmin, error: adminError } = await supabase.rpc('is_admin');
    console.log('Admin check result:', { isAdmin, adminError });
    
    if (!adminError && isAdmin) {
      document.getElementById('admin-link')?.classList.remove('hidden');
    } else {
      // Mostrar bot贸n de crear proyecto para usuarios no administradores
      document.getElementById('open-create-project')?.classList.remove('hidden');
    }
  })();

  document.getElementById('logout')?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login';
  });

  // Carga din谩mica de la librer铆a XLSX para exportaci贸n a Excel
  let XLSXMod: any = null;
  (async () => {
    try { XLSXMod = await import('xlsx'); }
    catch(e){ console.error('No se pudo cargar la librer铆a xlsx:', e); }
  })();

  function readCellValue(el: Element | null): string {
    if (!el) return '';
    const input = el.querySelector('input') as HTMLInputElement | null;
    const select = el.querySelector('select') as HTMLSelectElement | null;
    if (input) return (input.value || '').trim();
    if (select) return (select.value || '').trim();
    return (el.textContent || '').trim();
  }

  // Recolecta todos los datos mostrados en la interfaz en estructuras simples
  

  async function loadWorkspaces(){
    try {
      console.log('Loading workspaces...');
      
      // First, let's check if user is logged in
      const { data: { session } } = await supabase.auth.getSession();
      console.log('Current session:', session ? 'Active' : 'None');
      
      if (!session) {
        console.warn('No active session - user needs to log in');
        // Don't show alert, just return silently
        return;
      }
      
      console.log('User ID:', session.user.id);
      console.log('User email:', session.user.email);
      
      // Check if user has workspace membership
      const { data: memberships, error: membershipError } = await supabase
        .from('workspace_members')
        .select('workspace_id, role')
        .eq('user_id', session.user.id);
      
      console.log('Workspace memberships:', { memberships, membershipError });
      
      if (membershipError) {
        console.error('Error checking memberships:', membershipError);
        return;
      }
      
      if (!memberships || memberships.length === 0) {
        console.log('No workspace memberships found for user');
        // Create a default empty option
        const sel = document.getElementById('ws-select') as HTMLSelectElement | null;
        if (sel){
          sel.innerHTML = '<option value="">No workspaces available</option>';
        }
        // Mostrar CTA persistente para solicitar acceso
        const cta = document.getElementById('workspace-cta');
        const ctaLink = document.getElementById('workspace-cta-link') as HTMLAnchorElement | null;
        const ctaMsg = document.getElementById('workspace-cta-msg') as HTMLParagraphElement | null;
        const adminEmail = (import.meta as any).env?.PUBLIC_ADMIN_EMAIL || '';
        if (cta) cta.classList.remove('hidden');
        if (ctaLink) {
          if (adminEmail) {
            const subject = encodeURIComponent('Solicitud de acceso a workspace');
            const body = encodeURIComponent('Hola,\n\nSoy ' + session.user.email + ' y necesito acceso a un workspace para poder crear proyectos.\n\nGracias.');
            ctaLink.href = 'mailto:' + adminEmail + '?subject=' + subject + '&body=' + body;
            ctaLink.classList.remove('hidden');
          } else {
            ctaLink.classList.add('hidden');
          }
        }
        if (ctaMsg) {
          ctaMsg.textContent = adminEmail ? ('Se abrir谩 tu cliente de correo para escribir a ' + adminEmail + '.') : 'Contacta al administrador por el canal habitual para que te asigne a un workspace.';
        }
        return;
      }
      
      // Load workspaces that user has access to
      const workspaceIds = memberships.map(m => m.workspace_id);
      console.log('Loading workspaces with IDs:', workspaceIds);
      
      const { data, error } = await supabase
        .from('workspaces')
        .select('id, name')
        .in('id', workspaceIds)
        .order('name');
      
      console.log('Workspace query result:', { data, error });
      
      if (error) { 
        console.error('Error al cargar workspaces:', error); 
        return; 
      }
      
      workspaces = data || [];
      console.log('Workspaces loaded:', workspaces.length);
      
      if (workspaces.length === 0) {
        console.warn('No workspaces found with user memberships');
        // Create a default empty option
        const sel = document.getElementById('ws-select') as HTMLSelectElement | null;
        if (sel){
          sel.innerHTML = '<option value="">No workspaces available</option>';
        }
        return;
      }
      
      const sel = document.getElementById('ws-select') as HTMLSelectElement | null;
      if (sel){
        sel.innerHTML = '<option value="">(Sin workspace)</option>';
        workspaces.forEach(ws => {
          const opt = document.createElement('option'); opt.value = ws.id; opt.textContent = ws.name; sel.appendChild(opt);
        });
      }
      // Ocultar CTA si hay membres铆as disponibles
      const cta = document.getElementById('workspace-cta');
      if (cta) cta.classList.add('hidden');
    } catch (error) {
      console.error('Error en loadWorkspaces:', error);
      // Don't show alert, just log
    }
  }

  async function loadProjectsForWorkspace(wsId: string){
    if (!wsId){
      const sel = document.getElementById('project-select') as HTMLSelectElement | null;
      if (sel) sel.innerHTML = '<option value="">(Sin proyecto)</option>';
      return;
    }
    try {
      const { data, error } = await supabase.from('projects').select('id,name').eq('workspace_id', wsId).order('name');
      if (error) { 
        console.error('Error al cargar proyectos:', error); 
        return; 
      }
      projectsByWs[wsId] = data || [];
      const sel = document.getElementById('project-select') as HTMLSelectElement | null;
      if (sel){
        sel.innerHTML = '<option value="">(Sin proyecto)</option>';
        projectsByWs[wsId].forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; sel.appendChild(opt); });
      }
    } catch (error) {
      console.error('Error en loadProjectsForWorkspace:', error);
    }
  }

  // ------ M贸dulo de creaci贸n de proyecto (solo usuarios) ------
  async function loadUserWorkspacesForProject(){
    try {
      const { data: { session } } = await supabase.auth.getSession();
      const wsSelect = document.getElementById('user-proj-ws') as HTMLSelectElement | null;
      const note = document.getElementById('user-create-project-note') as HTMLParagraphElement | null;
      if (!wsSelect) return;
      if (!session) {
        wsSelect.innerHTML = '<option value="">Inicia sesi贸n</option>';
        if (note) note.textContent = 'Debes iniciar sesi贸n para crear proyectos.';
        return;
      }

      const { data: memberships, error: membershipError } = await supabase
        .from('workspace_members')
        .select('workspace_id, role')
        .eq('user_id', session.user.id);
      if (membershipError) {
        wsSelect.innerHTML = '<option value="">Error cargando workspaces</option>';
        if (note) note.textContent = 'Hubo un error al cargar tus workspaces.';
        return;
      }
      if (!memberships || memberships.length === 0) {
        wsSelect.innerHTML = '<option value="">No hay workspaces disponibles</option>';
        if (note) note.textContent = 'Para crear proyectos necesitas pertenecer a un workspace. Pide a un admin que te asigne uno.';
        return;
      }
      const workspaceIds = memberships.map(m => m.workspace_id);
      const { data, error } = await supabase
        .from('workspaces')
        .select('id, name')
        .in('id', workspaceIds)
        .order('name');
      if (error) {
        wsSelect.innerHTML = '<option value="">Error cargando workspaces</option>';
        if (note) note.textContent = 'No se pudieron cargar tus workspaces.';
        return;
      }
      const list = data || [];
      if (list.length === 0) {
        wsSelect.innerHTML = '<option value="">No hay workspaces disponibles</option>';
        if (note) note.textContent = 'Para crear proyectos necesitas pertenecer a un workspace.';
        return;
      }
      wsSelect.innerHTML = '<option value="">Selecciona un workspace</option>';
      list.forEach(ws => {
        const opt = document.createElement('option');
        opt.value = ws.id; opt.textContent = ws.name; wsSelect.appendChild(opt);
      });
      if (note) note.textContent = 'Selecciona un workspace y escribe el nombre del proyecto.';
    } catch (error) {
      const wsSelect = document.getElementById('user-proj-ws') as HTMLSelectElement | null;
      const note = document.getElementById('user-create-project-note') as HTMLParagraphElement | null;
      if (wsSelect) wsSelect.innerHTML = '<option value="">Error inesperado</option>';
      if (note) note.textContent = 'Ocurri贸 un error inesperado al cargar tus workspaces.';
    }
  }

  // Abrir/cerrar m贸dulo
  document.getElementById('open-create-project')?.addEventListener('click', async () => {
    const sec = document.getElementById('user-create-project');
    if (!sec) return;
    sec.classList.remove('hidden');
    await loadUserWorkspacesForProject();
  });
  document.getElementById('close-user-create-project')?.addEventListener('click', () => {
    const sec = document.getElementById('user-create-project');
    if (!sec) return;
    sec.classList.add('hidden');
  });

  // Submit crear proyecto
  document.getElementById('user-create-project-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = (document.getElementById('user-proj-name') as HTMLInputElement)?.value?.trim();
    const wsSel = (document.getElementById('user-proj-ws') as HTMLSelectElement);
    const workspace_id = wsSel?.value || '';
    if (!name) return alert('Nombre del proyecto requerido');
    if (!workspace_id) return alert('Selecciona un workspace');
    const { error } = await supabase.from('projects').insert({ name, workspace_id });
    if (error) return alert('Error al crear proyecto: ' + (error.message || ''));
    (document.getElementById('user-proj-name') as HTMLInputElement).value = '';
    alert('Proyecto creado');
    const sec = document.getElementById('user-create-project');
    sec?.classList.add('hidden');
    // actualizar selector de proyectos si coincide con workspace seleccionado
    const wsSelectMain = document.getElementById('ws-select') as HTMLSelectElement | null;
    if (wsSelectMain && wsSelectMain.value === workspace_id) {
      await loadProjectsForWorkspace(workspace_id);
    }
  });

  // Tabla editable con autocompletado y numeraci贸n autom谩tica
  const RESULT_COLOR = {
    'GANE': 'bg-green-700',
    'GANE DOBLADA': 'bg-green-700',
    'DIVIDI GANE': 'bg-green-700',
    'PERDI': 'bg-red-700',
    'PERDI DOBLADA': 'bg-red-700',
    'DIVIDI PERDI': 'bg-red-700',
    'EMPATE': 'bg-white/20',
    'BJ': 'bg-green-700'
  } as Record<string, string>;

  function paintRowColor(input: HTMLInputElement){
    const tr = input.closest('tr');
    if (!tr) return;
    // limpia
    tr.classList.remove('bg-green-700','bg-red-700','bg-white/20');
    const key = (input.value || '').trim().toUpperCase();
    const cls = RESULT_COLOR[key];
    if (cls) tr.classList.add(cls);
  }

  function makeRow(index: number, data?: {resultado?: string, diler?: string}){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-2 text-bj-white/80">${index}</td>
      <td class="py-2 pr-2">
        <input class="w-full px-2 py-1 rounded-md bg-white/10 border border-white/20" list="resultado-options" placeholder="Escribe o selecciona" />
      </td>
      <td class="py-2 pr-2">
        <input class="w-full px-2 py-1 rounded-md bg-white/10 border border-white/20" list="diler-options" placeholder="Escribe o selecciona" />
      </td>
      <td class="py-2 text-right">
        <button class="row-delete px-2 py-1 rounded-md bg-white/10 hover:bg-white/20 border border-white/20">X</button>
      </td>
    `;
    const [resInput, dilerInput] = tr.querySelectorAll('input') as NodeListOf<HTMLInputElement>;
    if (data?.resultado) resInput.value = data.resultado;
    if (data?.diler) dilerInput.value = data.diler;
    paintRowColor(resInput);

    // si se escribe en la 煤ltima fila, crear una nueva
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    function ensureNextRow(){
      const isLast = tr === body.lastElementChild;
      const hasText = resInput.value.trim() !== '' || dilerInput.value.trim() !== '';
      if (isLast && hasText) {
        // Actualizar datos actuales y, si se completan 10 manos, crear nueva p谩gina
        updateCurrentPageFromDOM();
        if (pages[currentPageIndex].length >= PAGE_SIZE) {
          createNewPage();
        } else {
          addEmptyRow();
        }
        updateCantidadDeManosInput();
        recomputeStats();
      }
    }
    resInput.addEventListener('input', ()=>{
      paintRowColor(resInput);
      updateCurrentPageFromDOM();
      recomputeStats();
      ensureNextRow();
    });
    dilerInput.addEventListener('input', ()=>{
      updateCurrentPageFromDOM();
      recomputeStats();
      ensureNextRow();
    });

    const delBtn = tr.querySelector('.row-delete') as HTMLButtonElement | null;
    delBtn?.addEventListener('click', () => {
      pushUndo();
      tr.remove();
      const body = document.getElementById('hands-body') as HTMLTableSectionElement;
      if (body.children.length === 0) addEmptyRow();
      renumberRows();
      updateCurrentPageFromDOM();
      updateCantidadDeManosInput();
      recomputeStats();
    });
    return tr;
  }

  function renumberRows(){
    const rows = Array.from(document.querySelectorAll('#hands-body tr'));
    rows.forEach((tr, i) => {
      const cell = tr.querySelector('td');
      if (cell) {
        const offset = currentPageIndex * PAGE_SIZE;
        cell.textContent = String(offset + i + 1);
      }
    });
  }

  function addEmptyRow(){
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    const index = body.children.length + 1;
    body.appendChild(makeRow(index));
  }

  // Paginaci贸n
  const PAGE_SIZE = 10;
  let pages: Array<{resultado: string, diler: string}[]> = [[]];
  let currentPageIndex = 0;

  // Agregados para estad铆sticas de rachas y porcentajes
  function allRows(){
    updateCurrentPageFromDOM();
    return pages.flat();
  }

  function recomputeStats(){
    const rows = allRows();
    const norm = (s: string) => (s||'').trim().toUpperCase();
    const total = rows.length;

    // Conteos totales para porcentajes (mantenemos l贸gica previa)
    const wonTotal = rows.filter(r => ['GANE','GANE DOBLADA','DIVIDI GANE','BJ'].includes(norm(r.resultado))).length;
    const lostTotal = rows.filter(r => ['PERDI','PERDI DOBLADA','DIVIDI PERDI'].includes(norm(r.resultado))).length;
    const tieTotal = rows.filter(r => norm(r.resultado) === 'EMPATE').length;

    // Rachas: considerar SOLO dos: GANADAS y PERDIDAS
    // GANADAS: cuentan consecutivos que CONTIENEN "GANE" o son exactamente "BJ";
    // se reinicia en 0 al detectar 'PERDI' o si NO contiene 'GANE' ni es 'BJ'.
    let streakGanadas = 0;
    for (let i = rows.length - 1; i >= 0; i--) {
      const r = norm(rows[i].resultado);
      if (r.includes('GANE') || r === 'BJ') {
        streakGanadas++;
      } else {
        break;
      }
    }
    // PERDIDAS: cuentan consecutivos que CONTIENEN la palabra "PERDI" (palabra principal);
    // se reinicia en 0 al detectar 'GANE' o si NO contiene 'PERDI'.
    let streakPerdidas = 0;
    for (let i = rows.length - 1; i >= 0; i--) {
      const r = norm(rows[i].resultado);
      if (r.includes('PERDI')) {
        streakPerdidas++;
      } else {
        break;
      }
    }

    const setText = (id: string, text: string) => { const el = document.getElementById(id); if (el) el.textContent = text; };
    setText('r-ganadas', String(streakGanadas));
    setText('r-perdidas', String(streakPerdidas));

    // Contadores de "cu谩ntas manos han pasado SIN que salga" cierta acci贸n
    const sinceLast = (match: (r:{resultado:string,diler:string})=>boolean) => {
      let c = 0;
      for (let i = rows.length - 1; i >= 0; i--) {
        if (match(rows[i])) break; // se detiene cuando aparece la acci贸n
        c++;
      }
      return c;
    };
    // MANOS SIN BJ: contar manos transcurridas desde la 煤ltima vez que el RESULTADO fue BJ
    const sinBJ = sinceLast(r => norm(r.resultado) === 'BJ');
    const ganeDob = sinceLast(r => norm(r.resultado).includes('GANE DOBLADA'));
    const perdiDob = sinceLast(r => norm(r.resultado).includes('PERDI DOBLADA'));
    const divGane = sinceLast(r => norm(r.resultado).includes('DIVIDI GANE'));
    const divPerdi = sinceLast(r => norm(r.resultado).includes('DIVIDI PERDI'));

    setText('r-sin-bj', String(sinBJ));
    setText('r-gane-doblada', String(ganeDob));
    setText('r-perdi-doblada', String(perdiDob));
    setText('r-dividi-gane', String(divGane));
    setText('r-dividi-perdi', String(divPerdi));

    // Porcentajes
    const pct = (n: number) => total > 0 ? Math.round((n*1000)/total)/10 : 0;
    setText('pct-ganadas-unit', String(wonTotal));
    setText('pct-perdidas-unit', String(lostTotal));
    setText('pct-empate-unit', String(tieTotal));
    setText('pct-ganadas', `${pct(wonTotal)}%`);
    setText('pct-perdidas', `${pct(lostTotal)}%`);
    setText('pct-empate', `${pct(tieTotal)}%`);
    setText('pct-total', '100%');

    // --- DILER: rachas y porcentajes ---
    const dVoloTotal = rows.filter(r => norm(r.diler) === 'VOLO').length;
    const dNoVoloTotal = rows.filter(r => norm(r.diler) === 'NO VOLO').length;
    const dBjTotal = rows.filter(r => norm(r.diler) === 'BJ').length;

    let dStreakVolo = 0;
    for (let i = rows.length - 1; i >= 0; i--) {
      const d = norm(rows[i].diler);
      if (d === 'VOLO') dStreakVolo++; else break;
    }
    let dStreakNoVolo = 0;
    for (let i = rows.length - 1; i >= 0; i--) {
      const d = norm(rows[i].diler);
      if (d === 'NO VOLO') dStreakNoVolo++; else break;
    }
    let dStreakBj = 0;
    for (let i = rows.length - 1; i >= 0; i--) {
      const d = norm(rows[i].diler);
      if (d === 'BJ') dStreakBj++; else break;
    }

    setText('d-streak-volo', String(dStreakVolo));
    setText('d-streak-novolo', String(dStreakNoVolo));
    setText('d-streak-bj', String(dStreakBj));

    setText('d-pct-volo-unit', String(dVoloTotal));
    setText('d-pct-novolo-unit', String(dNoVoloTotal));
    setText('d-pct-bj-unit', String(dBjTotal));
    setText('d-pct-volo', `${pct(dVoloTotal)}%`);
    setText('d-pct-novolo', `${pct(dNoVoloTotal)}%`);
    setText('d-pct-bj', `${pct(dBjTotal)}%`);
    setText('d-pct-total', '100%');
  }

  // Construir objeto de estad铆sticas (para guardar)
  function collectStats(){
    const rows = allRows();
    const norm = (s: string) => (s||'').trim().toUpperCase();
    const total = rows.length;
    const pct = (n: number) => total > 0 ? Math.round((n*1000)/total)/10 : 0;

    // Totales jugador
    const wonTotal = rows.filter(r => ['GANE','GANE DOBLADA','DIVIDI GANE','BJ'].includes(norm(r.resultado))).length;
    const lostTotal = rows.filter(r => ['PERDI','PERDI DOBLADA','DIVIDI PERDI'].includes(norm(r.resultado))).length;
    const tieTotal = rows.filter(r => norm(r.resultado) === 'EMPATE').length;

    // Rachas jugador
    let streakGanadas = 0; for (let i = rows.length - 1; i >= 0; i--) { const r = norm(rows[i].resultado); if (r.includes('GANE') || r === 'BJ') streakGanadas++; else break; }
    let streakPerdidas = 0; for (let i = rows.length - 1; i >= 0; i--) { const r = norm(rows[i].resultado); if (r.includes('PERDI')) streakPerdidas++; else break; }
    const sinceLast = (match: (r:{resultado:string,diler:string})=>boolean) => { let c=0; for(let i=rows.length-1;i>=0;i--){ if(match(rows[i])) break; c++; } return c; };
    const sinBJ = sinceLast(r => norm(r.resultado) === 'BJ');
    const ganeDob = sinceLast(r => norm(r.resultado).includes('GANE DOBLADA'));
    const perdiDob = sinceLast(r => norm(r.resultado).includes('PERDI DOBLADA'));
    const divGane = sinceLast(r => norm(r.resultado).includes('DIVIDI GANE'));
    const divPerdi = sinceLast(r => norm(r.resultado).includes('DIVIDI PERDI'));

    // Diler
    const dVoloTotal = rows.filter(r => norm(r.diler) === 'VOLO').length;
    const dNoVoloTotal = rows.filter(r => norm(r.diler) === 'NO VOLO').length;
    const dBjTotal = rows.filter(r => norm(r.diler) === 'BJ').length;
    let dStreakVolo = 0; for (let i = rows.length - 1; i >= 0; i--) { const d = norm(rows[i].diler); if (d === 'VOLO') dStreakVolo++; else break; }
    let dStreakNoVolo = 0; for (let i = rows.length - 1; i >= 0; i--) { const d = norm(rows[i].diler); if (d === 'NO VOLO') dStreakNoVolo++; else break; }
    let dStreakBj = 0; for (let i = rows.length - 1; i >= 0; i--) { const d = norm(rows[i].diler); if (d === 'BJ') dStreakBj++; else break; }

    return {
      total,
      jugador: {
        rachas: { ganadas: streakGanadas, perdidas: streakPerdidas, sinBJ, ganeDob, perdiDob, divGane, divPerdi },
        porcentajes: {
          unidad: { ganadas: wonTotal, perdidas: lostTotal, empate: tieTotal },
          porcentajes: { ganadas: pct(wonTotal), perdidas: pct(lostTotal), empate: pct(tieTotal) }
        }
      },
      diler: {
        rachas: { volo: dStreakVolo, noVolo: dStreakNoVolo, bj: dStreakBj },
        porcentajes: {
          unidad: { volo: dVoloTotal, noVolo: dNoVoloTotal, bj: dBjTotal },
          porcentajes: { volo: pct(dVoloTotal), noVolo: pct(dNoVoloTotal), bj: pct(dBjTotal) }
        }
      }
    };
  }

  function serializeDashboard(){
    updateCurrentPageFromDOM();
    return {
      version: 1,
      timestamp: new Date().toISOString(),
      totalHands: getTotalHandsCount(),
      currentPageIndex,
      pages,
      rows: allRows(),
      stats: collectStats()
    };
  }

  // Guardar en Supabase
  async function saveSnapshot(){
    try{
      const payload = serializeDashboard();
      const { data: sessionRes } = await supabase.auth.getSession();
      const userId = sessionRes?.session?.user?.id ?? null;
      const wsSel = document.getElementById('ws-select') as HTMLSelectElement | null;
      const prSel = document.getElementById('project-select') as HTMLSelectElement | null;
      // Si estamos editando y los selectores est谩n vac铆os, usar los IDs del snapshot
      const workspace_id = (wsSel?.value || editingSnapshotWsId || null);
      const project_id = (prSel?.value || editingSnapshotProjectId || null);
      
      // Determinar flujo de edici贸n
      let targetDate = new Date();
      let replaceOriginal = false;
      if (editingSnapshotId){
        const confirmReplace = confirm('驴Guardar encima del original?');
        if (confirmReplace){
          replaceOriginal = true;
          const keepOriginalDate = confirm('驴Usar la fecha ORIGINAL del snapshot? \nAceptar = mantener fecha original\nCancelar = usar fecha nueva');
          if (keepOriginalDate && editingSnapshotCreatedAt){
            targetDate = new Date(editingSnapshotCreatedAt);
          } else {
            targetDate = new Date();
          }
        } else {
          // Guardar como nuevo -> fecha actual
          targetDate = new Date();
        }
      }

      // Generar nombre con fecha y hora
      const now = targetDate;
      const dateStr = now.toLocaleDateString('es-ES');
      const timeStr = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
      const workspaceName = workspaces.find(w => w.id === workspace_id)?.name || 'Sin workspace';
      const projectName = (projectsByWs[workspace_id || ''] || []).find(p => p.id === project_id)?.name || 'Sin proyecto';
      const snapshotName = `${workspaceName} - ${projectName} - ${dateStr} ${timeStr}`;
      
      // Agregar el nombre al payload
      (payload as any).snapshot_name = snapshotName;
      payload.timestamp = now.toISOString();
      
      if (replaceOriginal && editingSnapshotId){
        // Actualizar snapshot existente
        const updateData: any = { data: payload, created_at: now.toISOString(), workspace_id, project_id };
        if (userId) updateData.user_id = userId;
        const { error } = await supabase.from('bj_snapshots').update(updateData).eq('id', editingSnapshotId);
        if (error) throw error;
        alert(`Snapshot actualizado: ${snapshotName}`);
      } else {
        // Insertar nuevo snapshot
        const insertData: any = { data: payload, created_at: now.toISOString(), workspace_id, project_id };
        if (userId) insertData.user_id = userId;
        const { error } = await supabase.from('bj_snapshots').insert(insertData);
        if (error) throw error;
        alert(`Snapshot guardado: ${snapshotName}`);
      }
      // Limpiar estado de edici贸n despu茅s de guardar
      editingSnapshotId = null; editingSnapshotCreatedAt = null; editingSnapshotWsId = null; editingSnapshotProjectId = null;
      setEditingIndicator(false);
      
      // Recargar el historial si est谩 visible
      const historialSection = document.getElementById('snapshots-section');
      if (historialSection && !historialSection.classList.contains('hidden')) {
        loadSnapshots();
      }
      
    }catch(e:any){
      console.error('Error al guardar', e);
      alert('Error al guardar: ' + (e?.message ?? e));
    }
  }

  document.getElementById('btn-save')?.addEventListener('click', saveSnapshot);


  // Listado y restauraci贸n de snapshots
  async function loadSnapshots(){
    const wsSel = document.getElementById('ws-select') as HTMLSelectElement | null;
    const prSel = document.getElementById('project-select') as HTMLSelectElement | null;
    const fromEl = document.getElementById('filter-from') as HTMLInputElement | null;
    const toEl = document.getElementById('filter-to') as HTMLInputElement | null;
    let q = supabase.from('bj_snapshots').select('id,created_at,workspace_id,project_id,data').order('created_at', { ascending: false }).limit(50);
    if (wsSel?.value) q = q.eq('workspace_id', wsSel.value);
    if (prSel?.value) q = q.eq('project_id', prSel.value);
    if (fromEl?.value) q = q.gte('created_at', new Date(fromEl.value + 'T00:00:00Z').toISOString());
    if (toEl?.value) q = q.lte('created_at', new Date(toEl.value + 'T23:59:59Z').toISOString());
    const { data, error } = await q;
    if (error) { console.error(error); alert('Error cargando snapshots'); return; }
    const tbody = document.getElementById('snapshots-body'); if (!tbody) return;
    tbody.innerHTML = '';
    (data||[]).forEach(row => {
      const tr = document.createElement('tr');
      const wsName = workspaces.find(w => w.id === row.workspace_id)?.name || '';
      const projs = projectsByWs[row.workspace_id || ''] || [];
      const pjName = projs.find(p => p.id === row.project_id)?.name || '';
      const totalHands = row.data?.totalHands ?? row.data?.stats?.total ?? 0;
      const dateStr = new Date(row.created_at).toLocaleString();
      const snapshotName = row.data?.snapshot_name || `${wsName} - ${pjName}`;
      
      tr.innerHTML = `
        <td class="py-2 pr-2 text-sm">${dateStr}</td>
        <td class="py-2 pr-2 text-sm font-medium">${snapshotName}</td>
        <td class="py-2 pr-2 text-sm">${wsName}</td>
        <td class="py-2 pr-2 text-sm">${pjName}</td>
        <td class="py-2 pr-2 text-sm">${totalHands}</td>
        <td class="py-2 pr-2 text-right">
          <button data-id="${row.id}" class="btn-restore text-blue-400 hover:text-blue-300 text-sm mr-2">Restaurar</button>
          <button data-id="${row.id}" class="btn-download text-yellow-400 hover:text-yellow-300 text-sm mr-2">Descargar</button>
          <button data-delete="${row.id}" class="btn-delete text-red-400 hover:text-red-300 text-sm">Eliminar</button>
        </td>`;
      tbody.appendChild(tr);
    });
    
    // Event listeners para restaurar
    tbody.querySelectorAll('.btn-restore').forEach(btn => {
      btn.addEventListener('click', async (ev) => {
        const id = (ev.target as HTMLButtonElement).getAttribute('data-id');
        if (!id) return;
        const { data, error } = await supabase.from('bj_snapshots').select('id, data, created_at, workspace_id, project_id').eq('id', id).single();
        if (error) { console.error(error); alert('Error al cargar snapshot'); return; }
        restoreFromSnapshot(data.data);
        // Marcar estado de edici贸n
        editingSnapshotId = data.id;
        editingSnapshotCreatedAt = data.created_at;
        editingSnapshotWsId = data.workspace_id || null;
        editingSnapshotProjectId = data.project_id || null;
        // Indicador visual
        const snapName = data.data?.snapshot_name || 'Snapshot';
        setEditingIndicator(true, snapName, data.created_at);
      });
    });
    
    // Event listeners para eliminar
    tbody.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async (ev) => {
        const id = (ev.target as HTMLButtonElement).getAttribute('data-delete');
        if (!id) return;
        if (!confirm('驴Eliminar este snapshot? Esta acci贸n no se puede deshacer.')) return;
        const { error } = await supabase.from('bj_snapshots').delete().eq('id', id);
        if (error) { console.error(error); alert('Error al eliminar snapshot'); return; }
        alert('Snapshot eliminado');
        loadSnapshots(); // Recargar lista
      });
    });
    
    // Event listeners para descargar
    tbody.querySelectorAll('.btn-download').forEach(btn => {
      btn.addEventListener('click', async (ev) => {
        const id = (ev.target as HTMLButtonElement).getAttribute('data-id');
        if (!id) return;
        await downloadSnapshotExcel(id);
      });
    });
  }

  function restoreFromSnapshot(snapshot: any){
    try{
      const version = snapshot?.version ?? 1;
      if (version !== 1) console.warn('Versi贸n de snapshot no esperada', version);
      pages = Array.isArray(snapshot.pages) ? snapshot.pages : [[]];
      currentPageIndex = Math.min(Math.max(0, snapshot.currentPageIndex ?? 0), pages.length - 1);
      renderPage();
      alert('Snapshot restaurado');
    }catch(e){
      console.error('Error restaurando snapshot', e);
      alert('Error restaurando snapshot');
    }
  }

  document.getElementById('btn-load-snapshots')?.addEventListener('click', loadSnapshots);

  // --- Descarga a Excel usando plantilla (XLSX por defecto) ---
  async function downloadSnapshotExcel(id: string){
    try {
      const { data, error } = await supabase.from('bj_snapshots').select('data, created_at, workspace_id, project_id').eq('id', id).single();
      if (error) { console.error(error); alert('Error cargando snapshot'); return; }
      const snap = (data as any)?.data || {};

      // Recalcular estad铆sticas si no existen
      // Compatibilidad: algunos snapshots antiguos guardan 'rows' (sin paginar) y otros 'pages'
      const normalizedRows = (() => {
        const byPages = Array.isArray(snap?.pages) ? (snap.pages as any[]).flat() : [];
        const byRows = Array.isArray(snap?.rows) ? (snap.rows as any[]) : [];
        const base = byPages.length ? byPages : byRows;
        return base as Array<{resultado?:string,diler?:string}>;
      })();
      const rowsAll = normalizedRows.filter((r:any) => (r?.resultado||'').trim()!=='' || (r?.diler||'').trim()!=='');
      const norm = (s:string) => (s||'').trim().toUpperCase();
      const total = rowsAll.length;
      const pctVal = (n:number) => total>0 ? Math.round((n*1000)/total)/10 : 0;
      const stats = snap?.stats ?? (()=>{
        const wonTotal = rowsAll.filter((r: { resultado?: string }) => ['GANE','GANE DOBLADA','DIVIDI GANE','BJ'].includes(norm(r.resultado || ''))).length;
        const lostTotal = rowsAll.filter((r: any) => ['PERDI','PERDI DOBLADA','DIVIDI PERDI'].includes(norm(r.resultado))).length;
        const tieTotal = rowsAll.filter((r: any) => norm(r.resultado) === 'EMPATE').length;
        let streakGanadas=0; for(let i=rowsAll.length-1;i>=0;i--){ const r=norm(rowsAll[i].resultado||''); if(r.includes('GANE')||r==='BJ') streakGanadas++; else break; }
        let streakPerdidas=0; for(let i=rowsAll.length-1;i>=0;i--){ const r=norm(rowsAll[i].resultado||''); if(r.includes('PERDI')) streakPerdidas++; else break; }
        const sinceLast=(fn:(r:any)=>boolean)=>{ let c=0; for(let i=rowsAll.length-1;i>=0;i--){ if(fn(rowsAll[i])) break; c++; } return c; };
        const sinBJ = sinceLast((r: any) => norm(r.resultado) === 'BJ');
        const ganeDob = sinceLast((r: any) => norm(r.resultado).includes('GANE DOBLADA'));
        const perdiDob = sinceLast((r: any) => norm(r.resultado).includes('PERDI DOBLADA'));
        const divGane = sinceLast((r: any) => norm(r.resultado).includes('DIVIDI GANE'));
        const divPerdi = sinceLast((r: any) => norm(r.resultado).includes('DIVIDI PERDI'));
        const dVoloTotal = rowsAll.filter((r: { diler?: string }) => norm(r.diler || '') === 'VOLO').length;
        const dNoVoloTotal = rowsAll.filter((r: { diler?: string }) => norm(r.diler || '') === 'NO VOLO').length;
        const dBjTotal = rowsAll.filter((r: { diler?: string }) => norm(r.diler || '') === 'BJ').length;
        let dStreakVolo=0; for(let i=rowsAll.length-1;i>=0;i--){ const d=norm(rowsAll[i].diler||''); if(d==='VOLO') dStreakVolo++; else break; }
        let dStreakNoVolo=0; for(let i=rowsAll.length-1;i>=0;i--){ const d=norm(rowsAll[i].diler||''); if(d==='NO VOLO') dStreakNoVolo++; else break; }
        let dStreakBj=0; for(let i=rowsAll.length-1;i>=0;i--){ const d=norm(rowsAll[i].diler||''); if(d==='BJ') dStreakBj++; else break; }
        return {
          total,
          jugador: {
            rachas: { ganadas: streakGanadas, perdidas: streakPerdidas, sinBJ, ganeDob, perdiDob, divGane, divPerdi },
            porcentajes: {
              unidad: { ganadas: wonTotal, perdidas: lostTotal, empate: tieTotal },
              porcentajes: { ganadas: pctVal(wonTotal), perdidas: pctVal(lostTotal), empate: pctVal(tieTotal) }
            }
          },
          diler: {
            rachas: { volo: dStreakVolo, noVolo: dStreakNoVolo, bj: dStreakBj },
            porcentajes: {
              unidad: { volo: dVoloTotal, noVolo: dNoVoloTotal, bj: dBjTotal },
              porcentajes: { volo: pctVal(dVoloTotal), noVolo: pctVal(dNoVoloTotal), bj: pctVal(dBjTotal) }
            }
          }
        };
      })();

      // Preparar hojas estilo interfaz
      const handsData: any[] = [['MANOS','RESULTADO JUGADOR','DILER']];
      rowsAll.forEach((h:any, idx:number) => handsData.push([idx+1, (h.resultado||'').trim(), (h.diler||'').trim()]));

      const rachasYM: any[] = [['CANTIDAD DE MANOS', String(rowsAll.length)], ['ULTIMAS RACHAS','CANTIDAD'],
        ['GANADAS', stats.jugador.rachas.ganadas],
        ['PERDIDAS', stats.jugador.rachas.perdidas],
        ['MANOS SIN BJ', stats.jugador.rachas.sinBJ],
        ['GANE DOBLADA', stats.jugador.rachas.ganeDob],
        ['PERDI DOBLADA', stats.jugador.rachas.perdiDob],
        ['DIVIDI GANE', stats.jugador.rachas.divGane],
        ['DIVIDI PERDI', stats.jugador.rachas.divPerdi]
      ];

      const porcentajes: any[] = [['ACCION','UNIDAD','%'],
        ['GANADAS', stats.jugador.porcentajes.unidad.ganadas, stats.jugador.porcentajes.porcentajes.ganadas/100],
        ['PERDIDAS', stats.jugador.porcentajes.unidad.perdidas, stats.jugador.porcentajes.porcentajes.perdidas/100],
        ['EMPATE', stats.jugador.porcentajes.unidad.empate, stats.jugador.porcentajes.porcentajes.empate/100],
        ['', '', 1]
      ];

      const dilerRachas: any[] = [['RACHAS DILER','CANTIDAD'],
        ['VOLO', stats.diler.rachas.volo],
        ['NO VOLO', stats.diler.rachas.noVolo],
        ['BJ', stats.diler.rachas.bj]
      ];

      const dilerPct: any[] = [['ACCION','UNIDAD','%'],
        ['VOLO', stats.diler.porcentajes.unidad.volo, stats.diler.porcentajes.porcentajes.volo/100],
        ['NO VOLO', stats.diler.porcentajes.unidad.noVolo, stats.diler.porcentajes.porcentajes.noVolo/100],
        ['BJ', stats.diler.porcentajes.unidad.bj, stats.diler.porcentajes.porcentajes.bj/100],
        ['', '', 1]
      ];

      // Leer plantilla y escribir valores en el sheet ORIGINAL para conservar estilos
      if (!XLSXMod){ XLSXMod = await import('xlsx'); }
      const resp = await fetch('/Plantilla_BJ_FINAL.xlsm');
      if (!resp.ok) throw new Error('No se pudo cargar la plantilla');
      const buf = await resp.arrayBuffer();
      const wb = XLSXMod.read(buf, { type: 'array' });
      const wsName = 'ORIGINAL';
      const ws = wb.Sheets[wsName] || wb.Sheets[wb.SheetNames[0]];

      const decode = XLSXMod.utils.decode_cell; const encode = XLSXMod.utils.encode_cell; const decodeRange = XLSXMod.utils.decode_range; const encodeRange = XLSXMod.utils.encode_range;
      function cellString(c:any){ return (typeof c?.v === 'string') ? c.v.trim() : ''; }
      function findCells(text:string){ const out:string[]=[]; for(const addr of Object.keys(ws)){ if(addr[0]==='!') continue; const v = cellString(ws[addr]); if(v.toUpperCase()===text.toUpperCase()) out.push(addr); } return out.sort((a,b)=>{const A=decode(a),B=decode(b); return A.r-B.r||A.c-B.c;}); }
      function writeRight(addr:string, val:any){ const rc=decode(addr); const tgt=encode({r:rc.r, c:rc.c+1}); const out:any = ws[tgt]||{}; out.t = typeof val==='number' ? 'n' : 's'; out.v = val; ws[tgt]=out; }
      function writeTwoRight(addr:string, val:number){ const rc=decode(addr); const tgt=encode({r:rc.r, c:rc.c+2}); const out:any = ws[tgt]||{}; out.t='n'; out.v=val; out.z='0.0%'; ws[tgt]=out; }
      function nearestTo(header:string, target:string){ const h = findCells(header)[0]; if(!h) return null; const H = decode(h); const acc = findCells(target); if(acc.length===0) return null; let best = acc[0]; let bestDist = Infinity; for(const a of acc){ const A=decode(a); const d = Math.abs(A.r-H.r)+Math.abs(A.c-H.c); if(d<bestDist) { bestDist=d; best=a; } } return best; }

      // Cantidad de manos
      const cantAddr = findCells('CANTIDAD DE MANOS')[0]; if (cantAddr) writeRight(cantAddr, rowsAll.length);

      // Rachas del jugador (debajo de "ULTIMAS RACHAS")
      const rHeader = findCells('ULTIMAS RACHAS')[0];
      if (rHeader){ const col = decode(rHeader).c; const row = decode(rHeader).r; const set = (label:string, val:number) => { const match = findCells(label).find(a=> decode(a).c===col && decode(a).r>row); if (match) writeRight(match, val); };
        set('GANADAS', stats.jugador.rachas.ganadas);
        set('PERDIDAS', stats.jugador.rachas.perdidas);
        set('MANOS SIN BJ', stats.jugador.rachas.sinBJ);
        set('GANE DOBLADA', stats.jugador.rachas.ganeDob);
        set('PERDI DOBLADA', stats.jugador.rachas.perdiDob);
        set('DIVIDI GANE', stats.jugador.rachas.divGane);
        set('DIVIDI PERDI', stats.jugador.rachas.divPerdi);
      }

      // Porcentajes del jugador: buscar bloque cercano a "PORCENTAJE %"
      const accionPct = nearestTo('PORCENTAJE %','ACCION');
      if (accionPct){ const c = decode(accionPct).c; const r = decode(accionPct).r; const set = (label:string, unidad:number, porcentaje:number) => { const lab = findCells(label).find(a=> decode(a).c===c && decode(a).r>r); if(lab){ writeRight(lab, unidad); writeTwoRight(lab, porcentaje/100); } };
        set('GANADAS', stats.jugador.porcentajes.unidad.ganadas, stats.jugador.porcentajes.porcentajes.ganadas);
        set('PERDIDAS', stats.jugador.porcentajes.unidad.perdidas, stats.jugador.porcentajes.porcentajes.perdidas);
        set('EMPATE', stats.jugador.porcentajes.unidad.empate, stats.jugador.porcentajes.porcentajes.empate);
      }

      // Rachas del diler
      const dHeader = findCells('RACHAS DILER')[0];
      if (dHeader){ const c = decode(dHeader).c; const r = decode(dHeader).r; const set = (label:string, val:number) => { const lab = findCells(label).find(a=> decode(a).c===c && decode(a).r>r); if(lab) writeRight(lab, val); };
        set('VOLO', stats.diler.rachas.volo);
        set('NO VOLO', stats.diler.rachas.noVolo);
        set('BJ', stats.diler.rachas.bj);
      }

      // Porcentajes del diler: bloque cercano a "DILER %"
      const accionDilerPct = nearestTo('DILER %','ACCION');
      if (accionDilerPct){ const c = decode(accionDilerPct).c; const r = decode(accionDilerPct).r; const set = (label:string, unidad:number, porcentaje:number) => { const lab = findCells(label).find(a=> decode(a).c===c && decode(a).r>r); if(lab){ writeRight(lab, unidad); writeTwoRight(lab, porcentaje/100); } };
        set('VOLO', stats.diler.porcentajes.unidad.volo, stats.diler.porcentajes.porcentajes.volo);
        set('NO VOLO', stats.diler.porcentajes.unidad.noVolo, stats.diler.porcentajes.porcentajes.noVolo);
        set('BJ', stats.diler.porcentajes.unidad.bj, stats.diler.porcentajes.porcentajes.bj);
      }

      // Registro de manos
      const manosHdr = findCells('MANOS')[0];
      if (manosHdr){
        const row = decode(manosHdr).r; const colManos = decode(manosHdr).c;
        // Buscar encabezados en la MISMA fila
        let resHdr:string|undefined; let dilHdr:string|undefined;
        for (const addr of Object.keys(ws)){
          if(addr[0]==='!') continue; const rc = decode(addr); if(rc.r!==row) continue; const txt = cellString(ws[addr]).toUpperCase();
          if (txt==='RESULTADO JUGADOR') resHdr = addr; if (txt==='DILER') dilHdr = addr;
        }
        const cRes = resHdr ? decode(resHdr).c : colManos+1;
        const cDil = dilHdr ? decode(dilHdr).c : colManos+2;
        const startRow = row + 1;

        // Limpiar previamente un rango amplio para evitar restos en la plantilla
        const clearRows = 500; // suficiente para uso normal
        function clearCell(r:number, c:number){
          const addr = encode({ r, c });
          const cell:any = ws[addr] || {};
          cell.t = 's';
          cell.v = '';
          ws[addr] = cell;
        }
        for(let i=0;i<clearRows;i++){
          const r = startRow + i;
          clearCell(r, colManos);
          clearCell(r, cRes);
          clearCell(r, cDil);
        }

        rowsAll.forEach((h:any, i:number) => {
          ws[encode({r:startRow+i, c:colManos})] = { t:'n', v:i+1 } as any;
          ws[encode({r:startRow+i, c:cRes})] = { t:'s', v:(h.resultado||'').trim() } as any;
          ws[encode({r:startRow+i, c:cDil})] = { t:'s', v:(h.diler||'').trim() } as any;
        });
        // No modificar ws['!ref'] para no romper referencias/formulas de la plantilla
      }

      const fname = `${(snap?.snapshot_name || 'snapshot')}.xlsm`;
      XLSXMod.writeFile(wb, fname, { bookType: 'xlsm' });
    } catch (e: any) {
      console.error(e);
      alert('Error generando Excel: ' + (e?.message ?? e));
    }
  }
  document.getElementById('ws-select')?.addEventListener('change', async (ev) => {
    const wsId = (ev.target as HTMLSelectElement).value;
    await loadProjectsForWorkspace(wsId);
  });

  function getTotalHandsCount(){
    updateCurrentPageFromDOM();
    return pages.reduce((sum, p) => sum + p.length, 0);
  }

  function updateCantidadDeManosInput(){
    const el = document.getElementById('cantidad-manos') as HTMLInputElement | null;
    if (el) el.value = String(getTotalHandsCount());
  }

  function updateCurrentPageFromDOM(){
    pages[currentPageIndex] = snapshotRows();
  }

  function updatePagerUI(){
    const countEl = document.getElementById('page-count');
    const numEl = document.getElementById('page-number');
    const sel = document.getElementById('page-select') as HTMLSelectElement | null;
    if (countEl) countEl.textContent = String(pages.length);
    if (numEl) numEl.textContent = String(currentPageIndex + 1);
    if (sel) {
      sel.innerHTML = '';
      for (let i=0;i<pages.length;i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = `P谩gina ${i+1}`;
        if (i === currentPageIndex) opt.selected = true;
        sel.appendChild(opt);
      }
    }
  }

  function renderPage(){
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    body.innerHTML = '';
    const rows = pages[currentPageIndex];
    rows.forEach((d, i) => body.appendChild(makeRow(i+1, d)));
    addEmptyRow();
    renumberRows();
    updatePagerUI();
    updateCantidadDeManosInput();
    recomputeStats();
  }

  function createNewPage(){
    pages.push([]);
    currentPageIndex = pages.length - 1;
    renderPage();
    // Focus primer input
    const first = document.querySelector('#hands-body tr input') as HTMLInputElement | null;
    first?.focus();
    updateCantidadDeManosInput();
    recomputeStats();
  }

  function loadExamples(){
    const example = [
      {resultado:'GANE', diler:'VOLO'},
      {resultado:'PERDI', diler:'NO VOLO'},
      {resultado:'EMPATE', diler:'BJ'},
      {resultado:'BJ'},
      {resultado:'GANE DOBLADA'},
      {resultado:'PERDI DOBLADA'},
      {resultado:'PERDI DOBLADA'},
      {resultado:'DIVIDI GANE'},
      {resultado:'DIVIDI PERDI'}
    ];
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    body.innerHTML = '';
    example.forEach((d, i) => body.appendChild(makeRow(i+1, d)));
    addEmptyRow();
  }

  // init: comenzar con la tabla vac铆a (una fila lista para escribir)
  (async function initEmpty(){
    console.log('Initializing dashboard...');
    pages = [[]];
    currentPageIndex = 0;
    renderPage();
    updateCantidadDeManosInput();
    recomputeStats();
    // Cargar workspaces al iniciar
    console.log('Loading workspaces...');
    await loadWorkspaces();
    console.log('Dashboard initialization complete');
  })();

  // Limpieza de columnas
  function clearColumns(opts: { resultado?: boolean, diler?: boolean }){
    pushUndo();
    const rows = Array.from(document.querySelectorAll('#hands-body tr')) as HTMLTableRowElement[];
    rows.forEach(tr => {
      const inputs = tr.querySelectorAll('input') as NodeListOf<HTMLInputElement>;
      const resInput = inputs[0];
      const dilerInput = inputs[1];
      if (opts.resultado && resInput) { resInput.value = ''; paintRowColor(resInput); }
      if (opts.diler && dilerInput) { dilerInput.value = ''; }
    });
  }

  function clearAll(){
    pushUndo();
    clearColumns({ resultado: true, diler: true });
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    // mantener solo una fila vac铆a
    body.innerHTML = '';
    addEmptyRow();
    renumberRows();
    recomputeStats();
  }

  function cleanEmptyRows(){
    pushUndo();
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    const rows = Array.from(body.querySelectorAll('tr')) as HTMLTableRowElement[];
    rows.forEach(tr => {
      const inputs = tr.querySelectorAll('input') as NodeListOf<HTMLInputElement>;
      const res = (inputs[0]?.value || '').trim();
      const dil = (inputs[1]?.value || '').trim();
      if (res === '' && dil === '') tr.remove();
    });
    if (body.children.length === 0) addEmptyRow();
    renumberRows();
    recomputeStats();
  }

  // Pila de deshacer (snapshot de filas)
  const undoStack: Array<{ rows: { resultado: string, diler: string }[] }> = [];
  const pagerUndoStack: Array<{ pages: Array<{resultado:string,diler:string}[]>, idx: number }> = [];
  function snapshotRows(){
    const rows = Array.from(document.querySelectorAll('#hands-body tr')) as HTMLTableRowElement[];
    return rows.map(tr => {
      const inputs = tr.querySelectorAll('input') as NodeListOf<HTMLInputElement>;
      return { resultado: inputs[0]?.value || '', diler: inputs[1]?.value || '' };
    }).filter(r => r.resultado.trim() !== '' || r.diler.trim() !== '');
  }
  function setRows(rows: { resultado: string, diler: string }[]){
    const body = document.getElementById('hands-body') as HTMLTableSectionElement;
    body.innerHTML = '';
    rows.forEach((d, i) => body.appendChild(makeRow(i+1, d)));
    addEmptyRow();
    renumberRows();
    recomputeStats();
  }
  function pushUndo(){
    undoStack.push({ rows: snapshotRows() });
    // snapshot de todas las p谩ginas
    pagerUndoStack.push({
      pages: pages.map(p => p.map(r => ({resultado: r.resultado, diler: r.diler}))),
      idx: currentPageIndex
    });
  }

  // Eventos UI
  document.getElementById('btn-clear-selected')?.addEventListener('click', () => {
    const res = (document.getElementById('chk-col-resultado') as HTMLInputElement)?.checked;
    const dil = (document.getElementById('chk-col-diler') as HTMLInputElement)?.checked;
    clearColumns({ resultado: res, diler: dil });
    updateCurrentPageFromDOM();
    updateCantidadDeManosInput();
    recomputeStats();
  });
  document.getElementById('btn-clear-all')?.addEventListener('click', () => {
    clearAll();
    pages[currentPageIndex] = [];
    renderPage();
    updateCantidadDeManosInput();
    recomputeStats();
  });
  document.getElementById('btn-undo')?.addEventListener('click', () => {
    const lastPages = pagerUndoStack.pop();
    if (lastPages) {
      pages = lastPages.pages.map(p => p.map(r => ({resultado: r.resultado, diler: r.diler})));
      currentPageIndex = Math.min(Math.max(0, lastPages.idx), pages.length - 1);
      renderPage();
      updateCantidadDeManosInput();
      recomputeStats();
      return;
    }
    const last = undoStack.pop();
    if (!last) return;
    setRows(last.rows);
    updateCantidadDeManosInput();
    recomputeStats();
  });
  document.getElementById('btn-clear-empty')?.addEventListener('click', () => {
    cleanEmptyRows();
    updateCurrentPageFromDOM();
    updateCantidadDeManosInput();
    recomputeStats();
  });

  // Pager events
  document.getElementById('page-prev')?.addEventListener('click', () => {
    updateCurrentPageFromDOM();
    if (currentPageIndex > 0) {
      currentPageIndex--;
      renderPage();
    }
  });
  document.getElementById('page-next')?.addEventListener('click', () => {
    updateCurrentPageFromDOM();
    if (currentPageIndex < pages.length - 1) {
      currentPageIndex++;
      renderPage();
    } else {
      createNewPage();
    }
  });
  document.getElementById('page-select')?.addEventListener('change', (ev) => {
    updateCurrentPageFromDOM();
    const sel = ev.target as HTMLSelectElement;
    const idx = parseInt(sel.value, 10);
    if (!Number.isNaN(idx)) {
      currentPageIndex = Math.min(Math.max(0, idx), pages.length - 1);
      renderPage();
    }
  });
  </script>
<!-- Secci贸n de snapshots movida arriba -->