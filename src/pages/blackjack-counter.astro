---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <main class="min-h-screen bg-gradient-to-br from-green-900 to-green-700 text-white">
    <header class="flex items-center justify-between max-w-6xl mx-auto p-6">
      <h1 class="text-2xl font-semibold">Contador de Cartas - Blackjack</h1>
      <div class="flex items-center gap-2">
        <a href="/dashboard" class="bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2">Dashboard</a>
        <button onclick="window.close()" class="bg-white/10 hover:bg-white/20 border border-white/20 rounded-md px-3 py-2">Cerrar</button>
      </div>
    </header>

    <div class="container mx-auto px-6">
      <p class="text-center text-green-200 mb-8">Sistema High-Low</p>
      
      <!-- Voice Control Button -->
      <div class="flex gap-3 mb-4">
        <button id="voiceControlBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
          <span id="voiceIcon">üé§</span>
          <span>Activar Control por Voz</span>
        </button>
        
        <button id="voiceHelpBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
          ‚ùì Ayuda
        </button>
      </div>
      
      <div class="grid gap-6 max-w-4xl mx-auto">
        <!-- Selector de mazos -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6">
          <label class="block text-white font-semibold mb-4">N√∫mero de Mazos:</label>
          <div class="flex gap-3 flex-wrap" id="deckButtons">
            <button class="deck-btn px-6 py-3 rounded-lg font-bold transition-all" data-decks="1">1</button>
            <button class="deck-btn px-6 py-3 rounded-lg font-bold transition-all" data-decks="2">2</button>
            <button class="deck-btn px-6 py-3 rounded-lg font-bold transition-all" data-decks="4">4</button>
            <button class="deck-btn px-6 py-3 rounded-lg font-bold transition-all active" data-decks="6">6</button>
            <button class="deck-btn px-6 py-3 rounded-lg font-bold transition-all" data-decks="8">8</button>
          </div>
        </div>

        <!-- Contadores -->
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6 text-center">
            <div class="text-sm text-white/70 mb-2">CONTEO ACTUAL</div>
            <div class="text-6xl font-bold mb-2" id="runningCount">0</div>
          </div>
          <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6 text-center">
            <div class="text-sm text-white/70 mb-2">CONTEO VERDADERO</div>
            <div class="text-5xl font-bold text-blue-400 mb-2" id="trueCount">0.00</div>
            <div class="text-xs text-white/50">Conteo / Mazos restantes</div>
          </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6">
          <div class="grid grid-cols-3 gap-4 text-center mb-4">
            <div>
              <div class="text-sm text-white/70">Cartas jugadas</div>
              <div class="text-xl font-bold" id="cardsPlayed">0</div>
            </div>
            <div>
              <div class="text-sm text-white/70">Cartas restantes</div>
              <div class="text-xl font-bold" id="cardsRemaining">312</div>
            </div>
            <div>
              <div class="text-sm text-white/70">Total</div>
              <div class="text-xl font-bold" id="totalCards">312</div>
            </div>
          </div>
          <div class="bg-white/10 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="bg-gradient-to-r from-green-500 to-green-600 h-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>

        <!-- Cartas -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6">
          <h3 class="text-lg font-semibold mb-4">Selecciona la carta que sali√≥:</h3>
          
          <div class="space-y-4">
            <!-- Cartas Bajas -->
            <div>
              <div class="text-sm text-green-400 font-semibold mb-2">CARTAS BAJAS (+1 - Favorables para el jugador)</div>
              <button id="card-low" class="card-btn w-full p-6 rounded-lg font-bold text-xl transition-all" style="background: #dcfce7; color: #059669;">
                <div class="text-3xl mb-2">2, 3, 4, 5, 6</div>
                <div class="text-2xl mb-2">+1</div>
                <div id="lowCardsRemaining" class="text-sm opacity-70">120 restantes</div>
              </button>
            </div>

            <!-- Cartas Neutrales -->
            <div>
              <div class="text-sm text-white/70 font-semibold mb-2">CARTAS NEUTRALES (0)</div>
              <button id="card-neutral" class="card-btn w-full p-6 rounded-lg font-bold text-xl transition-all" style="background: #f3f4f6; color: #6b7280;">
                <div class="text-3xl mb-2">7, 8, 9</div>
                <div class="text-2xl mb-2">0</div>
                <div id="neutralCardsRemaining" class="text-sm opacity-70">72 restantes</div>
              </button>
            </div>

            <!-- Cartas Altas -->
            <div>
              <div class="text-sm text-red-400 font-semibold mb-2">CARTAS ALTAS (-1 - Favorables para el casino)</div>
              <button id="card-high" class="card-btn w-full p-6 rounded-lg font-bold text-xl transition-all" style="background: #fee2e2; color: #dc2626;">
                <div class="text-3xl mb-2">10, J, Q, K, A</div>
                <div class="text-2xl mb-2">-1</div>
                <div id="highCardsRemaining" class="text-sm opacity-70">120 restantes</div>
              </button>
            </div>
          </div>
        </div>

        <!-- Bot√≥n Reiniciar -->
        <div class="bg-black/50 backdrop-blur border border-white/10 rounded-xl p-6">
          <button id="resetCount" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg transition-all">
            Reiniciar Conteo
          </button>
        </div>
      </div>
    </div>

    <!-- Voice Commands Help Modal -->
    <div id="voiceHelpModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-4 border border-gray-600">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-white">üé§ Comandos de Voz</h3>
          <button id="closeModalBtn" class="text-gray-400 hover:text-white text-2xl">√ó</button>
        </div>
        
        <div class="space-y-4 text-gray-300">
          <div>
            <h4 class="font-semibold text-green-400 mb-2">Cartas Bajas (+1)</h4>
            <p class="text-sm">Diga: <span class="bg-gray-700 px-2 py-1 rounded">2</span> <span class="bg-gray-700 px-2 py-1 rounded">3</span> <span class="bg-gray-700 px-2 py-1 rounded">4</span> <span class="bg-gray-700 px-2 py-1 rounded">5</span> <span class="bg-gray-700 px-2 py-1 rounded">6</span></p>
          </div>
          
          <div>
            <h4 class="font-semibold text-yellow-400 mb-2">Cartas Neutras (0)</h4>
            <p class="text-sm">Diga: <span class="bg-gray-700 px-2 py-1 rounded">7</span> <span class="bg-gray-700 px-2 py-1 rounded">8</span> <span class="bg-gray-700 px-2 py-1 rounded">9</span></p>
          </div>
          
          <div>
            <h4 class="font-semibold text-red-400 mb-2">Cartas Altas (-1)</h4>
            <p class="text-sm">Diga: <span class="bg-gray-700 px-2 py-1 rounded">10</span> <span class="bg-gray-700 px-2 py-1 rounded">J</span> <span class="bg-gray-700 px-2 py-1 rounded">Q</span> <span class="bg-gray-700 px-2 py-1 rounded">K</span> <span class="bg-gray-700 px-2 py-1 rounded">A</span></p>
          </div>
          
          <div>
            <h4 class="font-semibold text-blue-400 mb-2">Control</h4>
            <p class="text-sm">Diga: <span class="bg-gray-700 px-2 py-1 rounded">reiniciar</span> o <span class="bg-gray-700 px-2 py-1 rounded">reset</span></p>
          </div>
          
          <div class="bg-yellow-900 border border-yellow-600 rounded p-3 mt-4">
            <p class="text-yellow-200 text-sm">
              <strong>üí° Consejo:</strong> Hable claramente y espere un segundo entre comandos. El sistema tiene un peque√±o retardo para evitar errores.
            </p>
          </div>
          
          <div id="mobileVoiceWarning" class="bg-blue-900 border border-blue-600 rounded p-3 mt-4 hidden">
            <p class="text-blue-200 text-sm">
              <strong>üì± Modo M√≥vil:</strong> En dispositivos m√≥viles, el reconocimiento puede detenerse autom√°ticamente despu√©s de cada comando. Esto es normal - simplemente vuelva a activarlo si es necesario.
            </p>
          </div>
        </div>
        
        <div class="mt-6 text-center">
          <button id="closeModalBtn2" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition-colors">
            Entendido
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<!-- Voice Configuration - Optimizada para dictado ultra-r√°pido -->
<script id="voice-config" type="application/json">
{
  "shortTokens": {
    "numbers": ["1","2","3","4","5","6","7","8","9","10"],
    "letters": ["j","q","k","a"]
  },
  "thresholds": {
    "number": 0.08,
    "letter": 0.08
  },
  "cooldownMs": 50
}
</script>

<style>
  .deck-btn {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .deck-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  .deck-btn.active {
    background: #059669;
    color: white;
    transform: scale(1.05);
  }
  
  .card-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
  }
  
  .card-btn:hover {
    transform: scale(1.05);
    background: rgba(255, 255, 255, 0.2);
  }
  
  .card-btn:active {
    transform: scale(0.95);
  }
  
  .card-btn:disabled,
  .card-btn.disabled {
    background: rgba(255, 255, 255, 0.05) !important;
    color: rgba(255, 255, 255, 0.3) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    cursor: not-allowed !important;
    opacity: 0.5;
  }
</style>

<script is:inline>
  // @ts-nocheck
  /* eslint-disable */
  
  // VoiceCommands Class Integration
  class VoiceCommands {
    constructor() {
      /** @type {boolean} */
      this.isListening = false;
      /** @type {boolean} */
      this.shouldReconnect = false;
      /** @type {any} */
      this.recognition = null;
      /** @type {number} */
      this.actionCooldownMs = 100;
      /** @type {number} */
      this.lastActionTime = 0;
      /** @type {{
        lowCardBtn: HTMLElement|null,
        neutralCardBtn: HTMLElement|null,
        highCardBtn: HTMLElement|null,
        resetBtn: HTMLElement|null,
        voiceBtn: HTMLElement|null,
        voiceIcon: HTMLElement|null
      }} */
      this.domElements = this.cacheDOMElements();
      /** @type {boolean} */
      this.isMobile = this.detectMobile();
      /** @type {ReturnType<typeof setTimeout>|null} */
      this.reconnectTimeout = null;
      /** @type {boolean} */
      this.isUserRequestedStop = false;
      /** @type {Set<string>} */
      this.processedCommands = new Set();
      /** @type {Array<{command: string, timestamp: number}>} */
      this.commandHistory = [];
      /** @type {string} */
      this.lastProcessedCommand = '';
      /** @type {number} */
      this.lastProcessedTime = 0;
      /** @type {number} */
      this.consecutiveSuppressionWindowMs = 1200;

      // Precargar mapas para m√°xima velocidad
      /** @type {Record<string,string>} */
      this.numberMap = {
        'uno': '1', 'un': '1', 'una': '1', 'wan': '1',
        'dos': '2', 'tu': '2', 'too': '2', 
        'tres': '3', 'tre': '3',
        'cuatro': '4', 'cua': '4',
        'cinco': '5', 'sin': '5',
        'seis': '6', 'sais': '6',
        'siete': '7', 'sie': '7', 'set': '7',
        'ocho': '8', 'ochoa': '8',
        'nueve': '9', 'nue': '9',
        'diez': '10', 'die': '10'
      };

      /** @type {Record<string,string>} */
      this.letterMap = {
        'j': 'j', 'jota': 'j', 'jack': 'j', 'sota': 'j',
        'q': 'q', 'reina': 'q', 'queen': 'q',
        'k': 'k', 'rey': 'k', 'king': 'k',
        'a': 'a', 'as': 'a', 'ace': 'a', 'has': 'a', 'az': 'a', 'ha': 'a'
      };

      this.initializeRecognition();
      this.readConfigFromDom();
      
      console.log('Configuraci√≥n de VoiceCommands optimizada para dictado ultra-r√°pido');
    }

    detectMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    /**
     * @returns {{
     *  lowCardBtn: HTMLElement|null,
     *  neutralCardBtn: HTMLElement|null,
     *  highCardBtn: HTMLElement|null,
     *  resetBtn: HTMLElement|null,
     *  voiceBtn: HTMLElement|null,
     *  voiceIcon: HTMLElement|null
     * }}
     */
    cacheDOMElements() {
      return {
        lowCardBtn: document.getElementById('card-low'),
        neutralCardBtn: document.getElementById('card-neutral'),
        highCardBtn: document.getElementById('card-high'),
        resetBtn: document.getElementById('resetCount'),
        voiceBtn: document.getElementById('voiceControlBtn'),
        voiceIcon: document.getElementById('voiceIcon')
      };
    }

    readConfigFromDom() {
      try {
        const configElement = document.getElementById('voice-config');
        if (!configElement) {
          console.warn('No se encontr√≥ el elemento de configuraci√≥n de voz');
          return;
        }

        const config = JSON.parse(configElement.textContent);
        
        // Configuraci√≥n optimizada para dictado r√°pido
        this.actionCooldownMs = this.isMobile ? 80 : 40; // Muy r√°pido para dictado
        this.allowedSinglesNumbers = new Set(config.shortTokens?.numbers || []);
        this.allowedSinglesLetters = new Set(config.shortTokens?.letters || []);
        
        // Umbrales de confianza m√°s permisivos para dictado r√°pido
        this.thresholds = {
          number: this.isMobile ? 0.1 : 0.15, // Muy permisivo
          letter: this.isMobile ? 0.1 : 0.15
        };

        console.log('Configuraci√≥n de voz optimizada para dictado r√°pido:', {
          isMobile: this.isMobile,
          cooldownMs: this.actionCooldownMs,
          allowedNumbers: [...this.allowedSinglesNumbers],
          allowedLetters: [...this.allowedSinglesLetters],
          thresholds: this.thresholds
        });
      } catch (error) {
        console.error('Error al leer la configuraci√≥n de voz:', error);
      }
    }

    /**
     * Normaliza el token reconocible - Ultra-r√°pido con mapas precargados
     * @param {string} token
     * @returns {string}
     */
    normalizeToken(token) {
      if (!token || typeof token !== 'string') return '';
      
      const t = token.toLowerCase().trim().replace(/[.,;:!?¬ø¬°]/g, '');
      
      // Verificaci√≥n ultra-r√°pida de comandos cortos
      if (t.length === 1) {
        if (t >= '2' && t <= '9') return t;
        if (t === '1' || t === 'j' || t === 'q' || t === 'k' || t === 'a') return t;
        if (t === '0') return '10'; // Caso especial
      }
      
      // Verificaci√≥n de comandos de 2 caracteres
      if (t.length === 2) {
        if (t === '10') return '10';
        if (t === 'ha') return 'a';
        if (t === 'as') return 'a';
        if (t === 'az') return 'a';
      }
      
      // Usar mapas precargados (m√°s r√°pido que crear nuevos)
      if (this.numberMap[t]) {
        return this.numberMap[t];
      }
      
      if (this.letterMap[t]) {
        return this.letterMap[t];
      }
      
      // Si viene como n√∫mero con espacios
      const match = t.match(/\b(\d{1,2})\b/);
      return match ? match[1] : t;
    }

    initializeRecognition() {
      /** @type {any} */
      const w = window;
      const SR = w.SpeechRecognition || w.webkitSpeechRecognition;
      if (!SR) {
        console.error('El reconocimiento de voz no est√° soportado en este navegador');
        return;
      }

      this.recognition = new SR();
      
      // Configuraci√≥n optimizada para ambas plataformas
      if (this.isMobile) {
        // En m√≥viles: configuraci√≥n m√°s conservadora
        this.recognition.continuous = false;
        this.recognition.maxAlternatives = 1;
        this.recognition.interimResults = false; // Solo resultados finales
      } else {
        // En PC: configuraci√≥n m√°s sensible
        this.recognition.continuous = true;
        this.recognition.maxAlternatives = 3;
        this.recognition.interimResults = true;
      }
      
      // Configuraci√≥n com√∫n
      this.recognition.lang = 'es-ES';
      
      // Ajustes adicionales para mejor precisi√≥n
      if ('webkitSpeechRecognition' in window) {
        // @ts-ignore
        this.recognition.webkitSpeechRecognitionEndSilenceTimeout = 2000;
      }

      this.recognition.onstart = () => {
        console.log('Reconocimiento de voz iniciado');
        this.isListening = true;
        this.updateVoiceButton();
      };

      this.recognition.onend = () => {
        this.isListening = false;
        this.updateVoiceButton();

        // Reconexi√≥n ultra-r√°pida para dictado continuo
        if (this.shouldReconnect && !this.isUserRequestedStop) {
          // Limpiar timeout previo
          if (this.reconnectTimeout) {
            clearTimeout(this.reconnectTimeout);
          }
          
          // Reconexi√≥n inmediata para dictado r√°pido
          const reconnectDelay = this.isMobile ? 300 : 100;
          
          this.reconnectTimeout = setTimeout(() => {
            if (this.shouldReconnect && !this.isUserRequestedStop) {
              this.startListening();
            }
          }, reconnectDelay);
        }
      };

      /** @param {any} event */
      this.recognition.onerror = (event) => {
        console.error('Error en el reconocimiento de voz:', event.error);
        if (event.error === 'not-allowed') {
          console.log('Permiso de micr√≥fono denegado');
          this.shouldReconnect = false;
          this.isListening = false;
          this.updateVoiceButton();
        }
      };

      /** @param {any} event */
      this.recognition.onresult = (event) => {
        // Procesamiento optimizado para velocidad
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          
          // En m√≥viles, solo procesar resultados finales
          if (this.isMobile && !result.isFinal) {
            continue;
          }
          
          // Procesar solo la mejor alternativa para velocidad
          if (result.length > 0) {
            const bestResult = result[0];
            const raw = bestResult.transcript.toLowerCase().trim();
            const confidence = bestResult.confidence;
            
            // Procesar directamente sin crear arrays intermedios
            if (confidence > 0.05) { // Umbral m√≠nimo
              const words = raw.split(/\s+/);
              
              // Procesar cada palabra r√°pidamente
              for (const word of words) {
                const normalized = this.normalizeToken(word);
                if (normalized && !this.isOnCooldown()) {
                  if (normalized === 'reiniciar' || normalized === 'reset') {
                    this.processCommand('reset');
                    break;
                  } else {
                    this.processQuickCommand(normalized, confidence);
                  }
                }
              }
            }
          }
        }
      };
    }

    /**
     * Procesamiento ultra-r√°pido de comandos de voz
     * @param {string} transcript
     * @param {number} confidence
     */
    processQuickCommand(transcript, confidence) {
      // Verificaciones ultra-r√°pidas
      if (confidence < 0.05) return false; // M√≠nimo umbral
      
      const token = transcript;
      
      // Verificar duplicados y cooldown (r√°pido)
      if (this.isConsecutiveDuplicate(token) || this.isCommandProcessed(token) || this.isOnCooldown()) {
        return false;
      }
      
      // Procesamiento directo sin validaciones complejas
      const num = parseInt(token);
      if (!isNaN(num)) {
        if (num >= 2 && num <= 6) {
          this.domElements.lowCardBtn?.click();
          this.setLastProcessed(token);
          this.updateLastActionTime();
          return true;
        } else if (num >= 7 && num <= 9) {
          this.domElements.neutralCardBtn?.click();
          this.setLastProcessed(token);
          this.updateLastActionTime();
          return true;
        } else if (num === 10) {
          this.domElements.highCardBtn?.click();
          this.setLastProcessed(token);
          this.updateLastActionTime();
          return true;
        }
      }
      
      // Letras - verificaci√≥n directa
      if (token === 'j' || token === 'q' || token === 'k' || token === 'a') {
        this.domElements.highCardBtn?.click();
        this.setLastProcessed(token);
        this.updateLastActionTime();
        return true;
      }
      
      return false;
    }

    /** @param {string} command */
    processCommand(command) {
      command = command.toLowerCase().trim();
      
      // Verificar duplicados y cooldown
      if (this.isConsecutiveDuplicate(command) || this.isCommandProcessed(command) || this.isOnCooldown()) {
        return;
      }
      
      if (command === 'reset' || command === 'reiniciar') {
        console.log(`‚úÖ Comando de reset detectado: ${command}`);
        this.domElements.resetBtn?.click();
        this.setLastProcessed(command);
        this.updateLastActionTime();
      }
    }

    isOnCooldown() {
      return (Date.now() - this.lastActionTime) < this.actionCooldownMs;
    }

    updateLastActionTime() {
      this.lastActionTime = Date.now();
      // Limpiar comandos procesados despu√©s de un tiempo
      setTimeout(() => {
        this.processedCommands.clear();
      }, this.actionCooldownMs * 2);
    }
    
    /**
     * Verifica si un comando ya fue procesado recientemente - Optimizado para velocidad
     * @param {string} command 
     * @returns {boolean}
     */
    isCommandProcessed(command) {
      const now = Date.now();
      const key = `${command}_${Math.floor(now / 500)}`; // Ventana de 500ms para dictado r√°pido
      
      if (this.processedCommands.has(key)) {
        return true;
      }
      
      this.processedCommands.add(key);
      
      // Limpiar comandos antiguos de forma m√°s eficiente
      if (this.processedCommands.size > 20) {
        const keysToDelete = [];
        const currentWindow = Math.floor(now / 500);
        for (const k of this.processedCommands) {
          const keyWindow = parseInt(k.split('_')[1]);
          if (currentWindow - keyWindow > 2) { // M√°s de 1 segundo
            keysToDelete.push(k);
          }
        }
        keysToDelete.forEach(k => this.processedCommands.delete(k));
      }
      
      return false;
    }

    /** @param {string} command */
    isConsecutiveDuplicate(command) {
      return command === this.lastProcessedCommand && (Date.now() - this.lastProcessedTime) < this.consecutiveSuppressionWindowMs;
    }

    /** @param {string} command */
    setLastProcessed(command) {
      this.lastProcessedCommand = command;
      this.lastProcessedTime = Date.now();
    }

    startListening() {
      if (!this.recognition) {
        console.error('El reconocimiento de voz no est√° inicializado');
        return;
      }

      try {
        this.isUserRequestedStop = false;
        this.shouldReconnect = true;
        
        // Limpiar timeout previo si existe
        if (this.reconnectTimeout) {
          clearTimeout(this.reconnectTimeout);
          this.reconnectTimeout = null;
        }
        
        this.recognition.start();
        console.log('Iniciando reconocimiento de voz...');
      } catch (error) {
        console.error('Error al iniciar el reconocimiento de voz:', error);
        this.shouldReconnect = false;
        this.isListening = false;
        this.updateVoiceButton();
      }
    }

    stopListening() {
      if (!this.recognition) return;
      
      this.isUserRequestedStop = true;
      this.shouldReconnect = false;
      
      // Limpiar timeout de reconexi√≥n si existe
      if (this.reconnectTimeout) {
        clearTimeout(this.reconnectTimeout);
        this.reconnectTimeout = null;
      }
      
      try {
        this.recognition.stop();
        console.log('Deteniendo reconocimiento de voz...');
      } catch (error) {
        console.error('Error al detener el reconocimiento de voz:', error);
      }
    }

    toggleListening() {
      if (this.isListening) {
        this.stopListening();
      } else {
        this.startListening();
      }
    }

    updateVoiceButton() {
      if (!this.domElements.voiceBtn) return;

      if (this.isListening) {
        this.domElements.voiceBtn.style.backgroundColor = '#059669';
        const statusText = this.isMobile ? 'Desactivar Voz (M√≥vil)' : 'Desactivar Control por Voz';
        this.domElements.voiceBtn.innerHTML = `<span id="voiceIcon">üé§</span><span>${statusText}</span>`;
      } else {
        this.domElements.voiceBtn.style.backgroundColor = '#16a34a';
        const statusText = this.isMobile ? 'Activar Voz (M√≥vil)' : 'Activar Control por Voz';
        this.domElements.voiceBtn.innerHTML = `<span id="voiceIcon">üé§</span><span>${statusText}</span>`;
      }
    }
  }

  // Blackjack Game Logic
  let deckCount = 6;
  let runningCount = 0;
  let cardsPlayed = 0;
  const CARDS_PER_DECK = 52;
  let totalCards = deckCount * CARDS_PER_DECK;
  /** @type {any} */
  let voiceCommands = null;

  /** @param {number} value */
  function updateCount(value) {
    runningCount += value;
    cardsPlayed++;
    
    const remainingDecks = (totalCards - cardsPlayed) / CARDS_PER_DECK;
    const trueCount = (remainingDecks > 0) ? (runningCount / remainingDecks).toFixed(2) : "0.00";
    
    const runningCountEl = document.getElementById('runningCount');
    const trueCountEl = document.getElementById('trueCount');
    const cardsPlayedEl = document.getElementById('cardsPlayed');
    const cardsRemainingEl = document.getElementById('cardsRemaining');
    const progressBarEl = document.getElementById('progressBar');
    
    if (runningCountEl) runningCountEl.textContent = runningCount.toString();
    if (trueCountEl) trueCountEl.textContent = trueCount;
    if (cardsPlayedEl) cardsPlayedEl.textContent = cardsPlayed.toString();
    if (cardsRemainingEl) cardsRemainingEl.textContent = (totalCards - cardsPlayed).toString();
    
    const progress = (cardsPlayed / totalCards) * 100;
    if (progressBarEl) progressBarEl.style.width = progress + '%';
    
    if (runningCountEl) {
      if (runningCount > 0) {
        runningCountEl.className = 'text-6xl font-bold text-green-400';
      } else if (runningCount < 0) {
        runningCountEl.className = 'text-6xl font-bold text-red-400';
      } else {
        runningCountEl.className = 'text-6xl font-bold text-white';
      }
    }
    
    updateRemainingCards();
  }

  function updateRemainingCards() {
    const lowCardsPerDeck = 20;
    const neutralCardsPerDeck = 12;
    const highCardsPerDeck = 20;
    
    const totalLowCards = lowCardsPerDeck * deckCount;
    const totalNeutralCards = neutralCardsPerDeck * deckCount;
    const totalHighCards = highCardsPerDeck * deckCount;
    
    const lowCardsRemainingEl = document.getElementById('lowCardsRemaining');
    const neutralCardsRemainingEl = document.getElementById('neutralCardsRemaining');
    const highCardsRemainingEl = document.getElementById('highCardsRemaining');
    
    if (lowCardsRemainingEl) lowCardsRemainingEl.textContent = totalLowCards + ' restantes';
    if (neutralCardsRemainingEl) neutralCardsRemainingEl.textContent = totalNeutralCards + ' restantes';
    if (highCardsRemainingEl) highCardsRemainingEl.textContent = totalHighCards + ' restantes';
  }
  /** @param {number} count */
  function setDeckCount(count) {
    const allBtns = document.querySelectorAll('.deck-btn');
    allBtns.forEach((btn) => {
      btn.classList.remove('active');
      if (btn instanceof HTMLElement) {
        btn.style.background = 'rgba(255, 255, 255, 0.1)';
        btn.style.color = 'white';
        btn.style.transform = 'scale(1)';
      }
    });

    const selectedBtn = document.querySelector('[data-decks="' + count + '"]');
    if (selectedBtn) {
      selectedBtn.classList.add('active');
      if (selectedBtn instanceof HTMLElement) {
        selectedBtn.style.background = '#059669';
        selectedBtn.style.color = 'white';
        selectedBtn.style.transform = 'scale(1.05)';
      }
    }

    deckCount = count;
    totalCards = deckCount * CARDS_PER_DECK;

    const totalCardsEl = document.getElementById('totalCards');
    const cardsRemainingEl = document.getElementById('cardsRemaining');

    if (totalCardsEl) totalCardsEl.textContent = totalCards.toString();
    if (cardsRemainingEl) cardsRemainingEl.textContent = totalCards.toString();

    resetCount();
  }

  function resetCount() {
    runningCount = 0;
    cardsPlayed = 0;
    
    const runningCountEl = document.getElementById('runningCount');
    const trueCountEl = document.getElementById('trueCount');
    const cardsPlayedEl = document.getElementById('cardsPlayed');
    const cardsRemainingEl = document.getElementById('cardsRemaining');
    const progressBarEl = document.getElementById('progressBar');
    
    if (runningCountEl) {
      runningCountEl.textContent = '0';
      runningCountEl.className = 'text-6xl font-bold text-white';
    }
    if (trueCountEl) trueCountEl.textContent = '0.00';
    if (cardsPlayedEl) cardsPlayedEl.textContent = '0';
    if (cardsRemainingEl) cardsRemainingEl.textContent = totalCards.toString();
    if (progressBarEl) progressBarEl.style.width = '0%';
    
    updateRemainingCards();
  }

  // Initialize everything when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize voice commands
    try {
      voiceCommands = new VoiceCommands();
      /** @type {any} */ (window).voiceCommands = voiceCommands;
      console.log('Reconocimiento de voz inicializado correctamente');
    } catch (error) {
      console.error('Error al inicializar el reconocimiento de voz:', error);
      const voiceControlBtn = document.getElementById('voiceControlBtn');
      if (voiceControlBtn instanceof HTMLElement) {
        voiceControlBtn.style.display = 'none';
      }
    }
    
    // Event listeners for card buttons
    const lowCardBtn = document.getElementById('card-low');
    const neutralCardBtn = document.getElementById('card-neutral');
    const highCardBtn = document.getElementById('card-high');
    const resetBtn = document.getElementById('resetCount');
    const voiceBtn = document.getElementById('voiceControlBtn');
    const voiceHelpBtn = document.getElementById('voiceHelpBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeModalBtn2 = document.getElementById('closeModalBtn2');
    const modal = document.getElementById('voiceHelpModal');
    
    if (lowCardBtn) {
      lowCardBtn.addEventListener('click', function() {
        updateCount(1);
      });
    }
    
    if (neutralCardBtn) {
      neutralCardBtn.addEventListener('click', function() {
        updateCount(0);
      });
    }
    
    if (highCardBtn) {
      highCardBtn.addEventListener('click', function() {
        updateCount(-1);
      });
    }
    
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        resetCount();
      });
    }
    
    if (voiceBtn && voiceCommands) {
      voiceBtn.addEventListener('click', function() {
        voiceCommands.toggleListening();
      });
    }
    
    if (voiceHelpBtn && modal) {
      voiceHelpBtn.addEventListener('click', function() {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Mostrar advertencia m√≥vil si estamos en un dispositivo m√≥vil
        const mobileWarning = document.getElementById('mobileVoiceWarning');
        if (mobileWarning && voiceCommands && voiceCommands.isMobile) {
          mobileWarning.classList.remove('hidden');
        }
      });
    }
    
    if (closeModalBtn && modal) {
      closeModalBtn.addEventListener('click', function() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      });
    }
    
    if (closeModalBtn2 && modal) {
      closeModalBtn2.addEventListener('click', function() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      });
    }
    
    // Deck buttons
    const deckButtons = document.querySelectorAll('.deck-btn');
    deckButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        const decks = parseInt(btn.getAttribute('data-decks') || '6');
        setDeckCount(decks);
      });
    });
    
    // Initialize card counts
    updateRemainingCards();
    
    // Set 6 decks as active initially
    setDeckCount(6);
  });
</script>